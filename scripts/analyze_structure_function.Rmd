---
title: "Analyzing structure-function relationships in human brain"
author: "Evan Collins"
output: html_document
date: '2024-02-06'
---

All code in this markdown document has written by Evan Collins. Any questions can be sent to evantomcollins@gmail.com.

Note that all files generated from `process_neuroquery_data.ipynb`, `process_neurosynth_data.Rmd`, `compute_connectivities.Rmd`, and `compute_word_embeddings.Rmd` have been included in this GitHub repository. Nevertheless, it is important to note that prior to running the chunks of this R markdown, the following other R markdowns were run to generate some processed data files required for this R markdown: in this order, (1) `process_neuroquery_data.Rmd` was used to process data from NeuroQuery into the Yale Brain Atlas space, (2) `process_neurosynth_data.Rmd` was used to process data from Neurosynth into the Yale Brain Atlas space, (3) `compute_word_embeddings` was used to compute word embeddings for the functional terms of Neurosynth, and (4) `compute_connectivities.Rmd` was used to compute functional connectivity and structural connectivity

# 0. Load necessary packages and files

```{r, warning = FALSE, message = FALSE}
# Load packages
library(ggplot2)
library(reticulate)
library(mclust)
library(tidyverse)
library(plotly)
library(ggseg3d)
library(lsa)
library(corrplot)
library(png)
library(grid)
library(ggpubr)
library(ggbreak) 
library(patchwork)
library(Rtsne)
library(ggrepel)
library(ggcharts)
library(igraph)
library(quanteda)
library(MASS)
library(factoextra)
library(ggtext)
library(rmatio)
library(leaps)
library(Rmisc)
library(car)

# Load custom functions
source("utils.R")
```

```{r}
# Load files
# Yale Brain Atlas parcel dictionary
parcel_dict <- read.csv("../data/atlas/parcel_dict.csv")
parcel_names <- parcel_dict$Name
vertex_number_by_parcel <- parcel_dict$num_vertex

# Yale Brain Atlas whole brain positions and indices
atlas_whole_positions <- read.csv("../data/atlas/atlas_whole_positions.csv")
atlas_whole_indices <- read.csv("../data/atlas/atlas_whole_indices.csv")
# Yale Brain Atlas left hemisphere positions and indices
atlas_LH_positions <- read.csv("../data/atlas/atlas_LH_positions.csv")
atlas_LH_indices <- read.csv("../data/atlas/atlas_LH_indices.csv")
# Yale Brain Atlas right hemisphere positions and indices
atlas_RH_positions <- read.csv("../data/atlas/atlas_RH_positions.csv")
atlas_RH_indices <- read.csv("../data/atlas/atlas_RH_indices.csv")
# Yale Brain Atlas deep left hemisphere (amygdala, hippocampus, insula) positions and indices
atlas_deepLH_positions <- read.csv("../data/atlas/atlas_deepLH_positions.csv")
atlas_deepLH_indices <- read.csv("../data/atlas/atlas_deepLH_indices.csv")
# Yale Brain Atlas deep right hemisphere (amygdala, hippocampus, insula) positions and indices
atlas_deepRH_positions <- read.csv("../data/atlas/atlas_deepRH_positions.csv")
atlas_deepRH_indices <- read.csv("../data/atlas/atlas_deepRH_indices.csv")

# Load Neurosynth activation values in Yale Brain Atlas space
# average z scores for 334 functional terms across 690 parcel
# generated from process_neurosynth_data.Rmd
neurosynth_functional_activation_df <- read.csv("../data/metaanalysis/neurosynth/neurosynth_functional_activation_database.csv")
# Load Neuroquery activation values in Yale Brain Atlas space
# average z scores for 334 functional terms across 696 parcels
neuroquery_functional_activation_df <- read.csv("../data/metaanalysis/neuroquery/neuroquery_functional_activation_database.csv")

# Word embeddings of Neurosynth functional terms
# generated from compute_word_embeddings.Rmd
neurosynth_term_embedding_df <- read.csv("../data/metaanalysis/neurosynth/neurosynth_functional_term_word_embeddings.csv")

# Load connectivity (696 x 696 dimensions)
# generated from compute_connectivies.Rmd
sc_wmpathcount_matrix <- as.matrix(read.csv("../data/connectivity/sc_wmpathcount.csv"))
fc_neuroquery_matrix <- as.matrix(read.csv("../data/connectivity/fc_neuroquery.csv"))
fc_neurosynth_matrix <- as.matrix(read.csv("../data/connectivity/fc_neurosynth.csv"))
fc_rsfmri_matrix <- as.matrix(read.csv("../data/connectivity/fc_rsfmri.csv"))

# Functional and structural connectivity measures between Yale Brain Atlas parcels
# generated from compute_connectivies.Rmd
fc_sc_df <- read.csv("../data/connectivity/fc_sc.csv")

# Load NLP resources
# Concreteness dictionary (Brysbaert et al. 2014)
word_concreteness_df <- read.csv("../data/nlp/concreteness_table.csv")
# Linguistic Inquiry and Word Count (Pennebaker)
# Not available on GitHub for licensing reasons
# Visit liwc.app for access
# Once downloaded, move it into the "data/nlp" folder named as "LIWC2015_Dictionary.dic"
liwc2015dict <- dictionary(file = "../data/nlp/LIWC2015_Dictionary.dic", format = "LIWC")
```

# Figure 1

Methods flowchart in Figma

# Figure 2

## Figure 2A

Network figure generated from `generate_network_plot.ipynb`.

## Figure 2B

Spectral clustering dataframes generated from `spectral_clustering_and_diffusion_mapping.ipynb`.

```{r}
# Load in FC Neurosynth and SC spectral cluster designations 
# generated from spectral_clustering_and_diffusion_mapping.ipynb
fc_spec_clust_results_df <- read.csv("../data/connectivity/fc_specclust.csv")
sc_spec_clust_results_df <- read.csv("../data/connectivity/sc_specclust.csv")

# FC: generate colors for spectral cluster designation
fc_spec_clust_R <- c()
fc_spec_clust_G <- c()
fc_spec_clust_B <- c()
for (i in 1:696){
  if (fc_spec_clust_results_df$spectral_cluster[i] == 0){ # red
    fc_spec_clust_R[i] <- 255
    fc_spec_clust_G[i] <- 0
    fc_spec_clust_B[i] <- 0
  } else if (fc_spec_clust_results_df$spectral_cluster[i] == 1){ # orange
    fc_spec_clust_R[i] <- 255
    fc_spec_clust_G[i] <- 127
    fc_spec_clust_B[i] <- 0
  } else if (fc_spec_clust_results_df$spectral_cluster[i] == 2){ # yellow
    fc_spec_clust_R[i] <- 255
    fc_spec_clust_G[i] <- 255
    fc_spec_clust_B[i] <- 0
  } else if (fc_spec_clust_results_df$spectral_cluster[i] == 3){ # green
    fc_spec_clust_R[i] <- 0
    fc_spec_clust_G[i] <- 255
    fc_spec_clust_B[i] <- 0
  } else if (fc_spec_clust_results_df$spectral_cluster[i] == 4){ # blue
    fc_spec_clust_R[i] <- 0
    fc_spec_clust_G[i] <- 0
    fc_spec_clust_B[i] <- 255
  }
}

# SC: generate colors for spectral cluster designation
sc_spec_clust_R <- c()
sc_spec_clust_G <- c()
sc_spec_clust_B <- c()
for (i in 1:696){
  if (sc_spec_clust_results_df$new_spectral_cluster[i] == 0){ # red
    sc_spec_clust_R[i] <- 255
    sc_spec_clust_G[i] <- 0
    sc_spec_clust_B[i] <- 0
  } else if (sc_spec_clust_results_df$new_spectral_cluster[i] == 1){ # orange
    sc_spec_clust_R[i] <- 255
    sc_spec_clust_G[i] <- 127
    sc_spec_clust_B[i] <- 0
  } else if (sc_spec_clust_results_df$new_spectral_cluster[i] == 2){ # yellow
    sc_spec_clust_R[i] <- 255
    sc_spec_clust_G[i] <- 255
    sc_spec_clust_B[i] <- 0
  } else if (sc_spec_clust_results_df$new_spectral_cluster[i] == 3){ # green
    sc_spec_clust_R[i] <- 0
    sc_spec_clust_G[i] <- 255
    sc_spec_clust_B[i] <- 0
  } else if (sc_spec_clust_results_df$new_spectral_cluster[i] == 4){ # blue
    sc_spec_clust_R[i] <- 0
    sc_spec_clust_G[i] <- 0
    sc_spec_clust_B[i] <- 255
  }
}
```

```{r}
# FC Neurosynth
fc_clusters_brain_map <- plot_brain_map(R_values = fc_spec_clust_R, 
                                        G_values = fc_spec_clust_G, 
                                        B_values = fc_spec_clust_B)
fc_clusters_brain_map

ggsave("../figures/subplots/fig2_fc_clusters.png", 
       plot = fc_clusters_brain_map,
       width = 5100,
       height = 3000,
       units = "px")
```

```{r}
# Supplementary 1A
# Load in FC NeuroQuery cluster designations 
# generated from spectral_clustering_and_diffusion_mapping.ipynb
fc_neuroquery_spec_clust_results_df <- read.csv("../data/connectivity/fc_neuroquery_specclust.csv")

# FC: generate colors for spectral cluster designation
fc_neuroquery_spec_clust_R <- c()
fc_neuroquery_spec_clust_G <- c()
fc_neuroquery_spec_clust_B <- c()
for (i in 1:696){
  if (fc_neuroquery_spec_clust_results_df$spectral_cluster[i] == 0){ # red
    fc_neuroquery_spec_clust_R[i] <- 255
    fc_neuroquery_spec_clust_G[i] <- 0
    fc_neuroquery_spec_clust_B[i] <- 0
  } else if (fc_neuroquery_spec_clust_results_df$spectral_cluster[i] == 1){ # orange
    fc_neuroquery_spec_clust_R[i] <- 255
    fc_neuroquery_spec_clust_G[i] <- 127
    fc_neuroquery_spec_clust_B[i] <- 0
  } else if (fc_neuroquery_spec_clust_results_df$spectral_cluster[i] == 2){ # yellow
    fc_neuroquery_spec_clust_R[i] <- 255
    fc_neuroquery_spec_clust_G[i] <- 255
    fc_neuroquery_spec_clust_B[i] <- 0
  } else if (fc_neuroquery_spec_clust_results_df$spectral_cluster[i] == 3){ # green
    fc_neuroquery_spec_clust_R[i] <- 0
    fc_neuroquery_spec_clust_G[i] <- 255
    fc_neuroquery_spec_clust_B[i] <- 0
  } else if (fc_neuroquery_spec_clust_results_df$spectral_cluster[i] == 4){ # blue
    fc_neuroquery_spec_clust_R[i] <- 0
    fc_neuroquery_spec_clust_G[i] <- 0
    fc_neuroquery_spec_clust_B[i] <- 255
  }
}

# FC NeuroQuery
fc_neuroquery_clusters_brain_map <- plot_brain_map(R_values = fc_neuroquery_spec_clust_R, 
                                                   G_values = fc_neuroquery_spec_clust_G, 
                                                   B_values = fc_neuroquery_spec_clust_B)
fc_neuroquery_clusters_brain_map

ggsave("../figures/subplots/supp_fc_neuroquery_clusters.png", 
       plot = fc_neuroquery_clusters_brain_map,
       width = 5100,
       height = 3000,
       units = "px")
```


The spectral clusters in diffusion space figure in Figure 2B was generated from `spectral_clustering_and_diffusion_mapping.ipynb`. 

## Figure 2C

```{r}
sc_clusters_brain_map <- plot_brain_map(R_values = sc_spec_clust_R, 
                                        G_values = sc_spec_clust_G, 
                                        B_values = sc_spec_clust_B)
sc_clusters_brain_map

ggsave("../figures/subplots/fig2_sc_clusters.png", 
       plot = sc_clusters_brain_map,
       width = 5100,
       height = 3000,
       units = "px")
```

The spectral clusters in diffusion space in Figure 2C were generated from `spectral_clustering_and_diffusion_mapping.ipynb`. 

## Figure 2D

```{r, warning = F}
# Segment FC-SC dataframe into one specific for each FC version 
fc_sc_df_neuroquery <- fc_sc_df[, c(5, 8:20)]
fc_sc_df_neuroquery[] <- lapply(fc_sc_df_neuroquery, function(x) as.numeric(x))
fc_sc_df_neurosynth <- fc_sc_df[, c(6, 8:20)]
fc_sc_df_neurosynth[] <- lapply(fc_sc_df_neurosynth, function(x) as.numeric(x))
fc_sc_df_rsfmri <- fc_sc_df[, c(7, 8:20)]
fc_sc_df_rsfmri[] <- lapply(fc_sc_df_rsfmri, function(x) as.numeric(x))

fc_sc_df_neuroquery_clean <- fc_sc_df_neuroquery
names(fc_sc_df_neuroquery_clean) <- c("FC - NeuroQuery", "SC - Count", "SC - Length", "SC - Path Length", "SC - Path Count", "SC - Eucl Dist", "SC - Cosine", "SC - Flow Graph", "SC - Matching Index", "SC - Nav Count", "SC - Nav Length", "SC - Path Transitivity", "SC - Search Info", "SC - MFPT")

fc_sc_df_neurosynth_clean <- fc_sc_df_neurosynth
names(fc_sc_df_neurosynth_clean) <- c("FC - Neurosynth", "SC - Count", "SC - Length", "SC - Path Length", "SC - Path Count", "SC - Eucl Dist", "SC - Cosine", "SC - Flow Graph", "SC - Matching Index", "SC - Nav Count", "SC - Nav Length", "SC - Path Transitivity", "SC - Search Info", "SC - MFPT")

fc_sc_df_rsfmri_clean <- fc_sc_df_rsfmri
names(fc_sc_df_rsfmri_clean) <- c("FC - rsfMRI", "SC - Count", "SC - Length", "SC - Path Length", "SC - Path Count", "SC - Eucl Dist", "SC - Cosine", "SC - Flow Graph", "SC - Matching Index", "SC - Nav Count", "SC - Nav Length", "SC - Path Transitivity", "SC - Search Info", "SC - MFPT")

# Compute pairwise adjusted R squared values for FC NeuroQuery
adjr2_neuroquery_matrix <- cor(fc_sc_df_neuroquery_clean, method = "pearson")
adjr2_neuroquery_matrix[] <- NA
for (i in 1:dim(adjr2_neuroquery_matrix)[1]){
  for (j in 1:dim(adjr2_neuroquery_matrix)[2]){
    adjr2_neuroquery_matrix[i,j] <- summary(lm(fc_sc_df_neuroquery_clean[,j] ~ fc_sc_df_neuroquery_clean[,i]))$adj.r.squared
  }
}
# Set very small negative values to 0; computation error
adjr2_neuroquery_matrix[adjr2_neuroquery_matrix < 0] <- 0

# Compute pairwise adjusted R squared values for FC Neurosynth
adjr2_neurosynth_matrix <- cor(fc_sc_df_neurosynth_clean, method = "pearson")
adjr2_neurosynth_matrix[] <- NA
for (i in 1:dim(adjr2_neurosynth_matrix)[1]){
  for (j in 1:dim(adjr2_neurosynth_matrix)[2]){
    adjr2_neurosynth_matrix[i,j] <- summary(lm(fc_sc_df_neurosynth_clean[,j] ~ fc_sc_df_neurosynth_clean[,i]))$adj.r.squared
  }
}
# Set very small negative values to 0; computation error
adjr2_neurosynth_matrix[adjr2_neurosynth_matrix < 0] <- 0

# Compute pairwise adjusted R squared values for FC rsfMRI
adjr2_rsfmri_matrix <- cor(fc_sc_df_rsfmri_clean, method = "pearson")
adjr2_rsfmri_matrix[] <- NA
for (i in 1:dim(adjr2_rsfmri_matrix)[1]){
  for (j in 1:dim(adjr2_rsfmri_matrix)[2]){
    adjr2_rsfmri_matrix[i,j] <- summary(lm(fc_sc_df_rsfmri_clean[,j] ~ fc_sc_df_rsfmri_clean[,i]))$adj.r.squared
  }
}
# Set very small negative values to 0; computation error
adjr2_rsfmri_matrix[adjr2_rsfmri_matrix < 0] <- 0
```

```{r}
# Correlation heatmap for FC Neuroquery
png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/fig2_corrplot_all_neuroquery.png")

corrplot(adjr2_neuroquery_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = FALSE,
         col = colorRampPalette(c("white","red"))(200),
         col.lim = c(min(adjr2_neuroquery_matrix), max(adjr2_neuroquery_matrix)))
```


```{r}
# Correlation heatmap for FC Neurosynth
png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/fig2_corrplot_all_neurosynth.png")

corrplot(adjr2_neurosynth_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = FALSE,
         col = colorRampPalette(c("white","red"))(200),
         col.lim = c(min(adjr2_neurosynth_matrix), max(adjr2_neurosynth_matrix)))
```

```{r}
# Correlation heatmap for FC rsfMRI
png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/fig2_corrplot_all_rsfmri.png")

corrplot(adjr2_rsfmri_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         number.digits = 2,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = FALSE,
         col = colorRampPalette(c("white","red"))(200),
         col.lim = c(min(adjr2_rsfmri_matrix), max(adjr2_rsfmri_matrix)))
```


```{r}
# Supplementary - compute Spearman rho correlation map for all data
# Spearman rho heatmap for FC Neuroquery
spearmanrho_neuroquery_matrix <- cor(fc_sc_df_neuroquery_clean, method = "s")

png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/supp_spearmanrho_corrplot_all_neuroquery.png")

corrplot(spearmanrho_neuroquery_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = TRUE,
         col = colorRampPalette(c("blue","white","red"))(200))
```


```{r}
# Spearman rho heatmap for FC Neurosynth
spearmanrho_neurosynth_matrix <- cor(fc_sc_df_neurosynth_clean, method = "s")

png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/supp_spearmanrho_corrplot_all_neurosynth.png")

corrplot(spearmanrho_neurosynth_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = TRUE,
         col = colorRampPalette(c("blue","white","red"))(200))
```

```{r}
# Spearman rho heatmap for FC rsfMRI
spearmanrho_rsfmri_matrix <- cor(fc_sc_df_rsfmri_clean, method = "s")

png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/supp_spearmanrho_corrplot_all_rsfmri.png")

corrplot(spearmanrho_rsfmri_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         number.digits = 2,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = TRUE,
         col = colorRampPalette(c("blue","white","red"))(200))
```

```{r}
# Supplementary - Compute R2 out-of-sample maps averaged across 10 cross-validation folds
k <- 10
set.seed(1)
#folds <- sample(1:k, nrow(fc_sc_df_neuroquery), replace = TRUE) # random splitting
# Perform parcelwise train/test splitting for 10 cross validation folds
# Any connection that involves at least one of the test parcels is placed in the test dataset
folds_parcelsplit_parcels <- sample(1:k, 696, replace = TRUE)
folds_parcelsplit_df <- data.frame("fold_1" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_2" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_3" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_4" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_5" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_6" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_7" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_8" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_9" = rep(NA, nrow(fc_sc_df_neuroquery)),
                                   "fold_10" = rep(NA, nrow(fc_sc_df_neuroquery)))
for (i in 1:nrow(fc_sc_df)){
  svMisc::progress(i, nrow(fc_sc_df))
  for (j in 1:ncol(folds_parcelsplit_df)){
    # If parcel appears in either A or B pair position, then move to test set
    if ((folds_parcelsplit_parcels[fc_sc_df$Parcel_A_ID[i]] == j) | (folds_parcelsplit_parcels[fc_sc_df$Parcel_B_ID[i]] == j)){
      folds_parcelsplit_df[i,j] <- "test"
    } else {
      folds_parcelsplit_df[i,j] <- "train"
    }
  }
}
#write.csv(folds_parcelsplit_df, "../data/connectivity/cv_splits_parcelwise.csv", row.names = F)
folds_parcelsplit_df <- read.csv("../data/connectivity/cv_splits_parcelwise.csv")

# Compute pairwise adjusted R2 OOS values from 10-fold CV for FC NeuroQuery
# Parcelwise split
adjr2oos_neuroquery_matrix <- cor(fc_sc_df_neuroquery, method = "pearson")
adjr2oos_neuroquery_matrix[] <- NA
for (i in 1:dim(adjr2oos_neuroquery_matrix)[1]){
  svMisc::progress(i, dim(adjr2oos_neuroquery_matrix)[1])
  for (j in 1:dim(adjr2oos_neuroquery_matrix)[2]){
    if (i == j){
      adjr2oos_neuroquery_matrix[i,j] <- 1
    } else {
      cv_adjr2oos <- rep(NA, k)
      for (m in 1:k){ # for each cv
        lm_model_ij_k <- lm(paste0(names(fc_sc_df_neuroquery)[j], "~", names(fc_sc_df_neuroquery)[i]), data = fc_sc_df_neuroquery[which(folds_parcelsplit_df[,m] == "train"), ])
        pred_x <- predict.lm(lm_model_ij_k, fc_sc_df_neuroquery[which(folds_parcelsplit_df[,m] == "test"), ][i])
        cv_mse <- mean((fc_sc_df_neuroquery[which(folds_parcelsplit_df[,m] == "test"), j] - pred_x)^2)
        n <- length(fc_sc_df_neuroquery[which(folds_parcelsplit_df[,m] == "test"), j])
        margVar <- var(fc_sc_df_neuroquery[which(folds_parcelsplit_df[,m] == "test"), j])
        mst <- (n+1)/n*margVar
        cv_r2oos <- 1 - cv_mse/mst
        cv_adjr2oos[m] <- 1 - ((1 - cv_r2oos)*(n - 1))/(n - j - 1)
      }
      adjr2oos_neuroquery_matrix[i,j] <- mean(cv_adjr2oos)
    }
  }
}
# Set very small negative values to 0; computation error
adjr2oos_neuroquery_matrix[adjr2oos_neuroquery_matrix < 0] <- 0
colnames(adjr2oos_neuroquery_matrix) <- names(fc_sc_df_neuroquery_clean)
rownames(adjr2oos_neuroquery_matrix) <- names(fc_sc_df_neuroquery_clean)


# Compute pairwise adjusted R2 OOS values from 10-fold CV for FC Neurosynth
# Parcelwise split
adjr2oos_neurosynth_matrix <- cor(fc_sc_df_neurosynth, method = "pearson")
adjr2oos_neurosynth_matrix[] <- NA
for (i in 1:dim(adjr2oos_neurosynth_matrix)[1]){
  svMisc::progress(i, dim(adjr2oos_neurosynth_matrix)[1])
  for (j in 1:dim(adjr2oos_neurosynth_matrix)[2]){
    if (i == j){
      adjr2oos_neurosynth_matrix[i,j] <- 1
    } else {
      cv_adjr2oos <- rep(NA, k)
      for (m in 1:k){ # for each cv
        lm_model_ij_k <- lm(paste0(names(fc_sc_df_neurosynth)[j], "~", names(fc_sc_df_neurosynth)[i]), fc_sc_df_neurosynth[which(folds_parcelsplit_df[,m] == "train"), ])
        pred_x <- predict.lm(lm_model_ij_k, fc_sc_df_neurosynth[which(folds_parcelsplit_df[,m] == "test"), ][i])
        cv_mse <- mean((fc_sc_df_neurosynth[which(folds_parcelsplit_df[,m] == "test"), j] - pred_x)^2)
        n <- length(fc_sc_df_neurosynth[which(folds_parcelsplit_df[,m] == "test"), j])
        margVar <- var(fc_sc_df_neurosynth[which(folds_parcelsplit_df[,m] == "test"), j])
        mst <- (n+1)/n*margVar
        cv_r2oos <- 1 - cv_mse/mst
        cv_adjr2oos[m] <- 1 - ((1 - cv_r2oos)*(n - 1))/(n - j - 1)
      }
      adjr2oos_neurosynth_matrix[i,j] <- mean(cv_adjr2oos)
    }
  }
}
# Set very small negative values to 0; computation error
adjr2oos_neurosynth_matrix[adjr2oos_neurosynth_matrix < 0] <- 0
colnames(adjr2oos_neurosynth_matrix) <- names(fc_sc_df_rsfmri_clean)
rownames(adjr2oos_neurosynth_matrix) <- names(fc_sc_df_rsfmri_clean)


# Compute pairwise adjusted R2 OOS values from 10-fold CV for FC rsfmri
# Parcelwise split
adjr2oos_rsfmri_matrix <- cor(fc_sc_df_rsfmri, method = "pearson")
adjr2oos_rsfmri_matrix[] <- NA
for (i in 1:dim(adjr2oos_rsfmri_matrix)[1]){
  svMisc::progress(i, dim(adjr2oos_rsfmri_matrix)[1])
  for (j in 1:dim(adjr2oos_rsfmri_matrix)[2]){
    if (i == j){
      adjr2oos_rsfmri_matrix[i,j] <- 1
    } else {
      cv_adjr2oos <- rep(NA, k)
      for (m in 1:k){ # for each cv
        lm_model_ij_k <- lm(paste0(names(fc_sc_df_rsfmri)[j], "~", names(fc_sc_df_rsfmri)[i]), data = fc_sc_df_rsfmri[which(folds_parcelsplit_df[,m] == "train"), ])
        pred_x <- predict.lm(lm_model_ij_k, fc_sc_df_rsfmri[which(folds_parcelsplit_df[,m] == "test"), ][i])
        cv_mse <- mean((fc_sc_df_rsfmri[which(folds_parcelsplit_df[,m] == "test"), j] - pred_x)^2)
        n <- length(fc_sc_df_rsfmri[which(folds_parcelsplit_df[,m] == "test"), j])
        margVar <- var(fc_sc_df_rsfmri[which(folds_parcelsplit_df[,m] == "test"), j])
        mst <- (n+1)/n*margVar
        cv_r2oos <- 1 - cv_mse/mst
        cv_adjr2oos[m] <- 1 - ((1 - cv_r2oos)*(n - 1))/(n - j - 1)
      }
      adjr2oos_rsfmri_matrix[i,j] <- mean(cv_adjr2oos)
    }
  }
}
# Set very small negative values to 0; computation error
adjr2oos_rsfmri_matrix[adjr2oos_rsfmri_matrix < 0] <- 0
colnames(adjr2oos_rsfmri_matrix) <- names(fc_sc_df_rsfmri_clean)
rownames(adjr2oos_rsfmri_matrix) <- names(fc_sc_df_rsfmri_clean)
```


```{r}
# Correlation prediction heatmap for FC NeuroQuery
png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/supp_corrplot_cv_neuroquery.png")

corrplot(adjr2oos_neuroquery_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = FALSE,
         col = colorRampPalette(c("white","red"))(200),
         col.lim = c(min(adjr2oos_neuroquery_matrix), max(adjr2oos_neuroquery_matrix)))
```


```{r}
# Correlation prediction heatmap for FC Neurosynth
png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/supp_corrplot_cv_neurosynth.png")

corrplot(adjr2oos_neurosynth_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = FALSE,
         col = colorRampPalette(c("white","red"))(200),
         col.lim = c(min(adjr2oos_neurosynth_matrix), max(adjr2oos_neurosynth_matrix)))
```


```{r}
# Correlation prediction heatmap for FC rsfmri
png(height = 2000, 
    width = 2000, 
    file = "../figures/subplots/supp_corrplot_cv_rsfmri.png")

corrplot(adjr2oos_rsfmri_matrix,
         method = "color", 
         type = "lower", 
         addCoef.col = "black", 
         order = "original", 
         tl.col = "black",
         tl.srt = 30,
         tl.cex = 3.5,
         tl.offset = 0.8,
         number.cex = 3,
         cl.cex = 3,
         cl.length = 3,
         diag = FALSE,
         is.corr = FALSE,
         col = colorRampPalette(c("white","red"))(200),
         col.lim = c(min(adjr2oos_rsfmri_matrix), max(adjr2oos_rsfmri_matrix)))
```


## Figure 2E

```{r}
# Supplementary
# Linear model selection by exhaustive search for FC Neurosynth
model_search_neurosynth <- regsubsets(FC_Neurosynth ~ ., data = fc_sc_df_neurosynth, nvmax = 13)
model_search_neurosynth_summary <- summary(model_search_neurosynth)

model_search_neurosynth_summary_df <- data.frame("predictors" = c(1:13, 1:13),
                                                 "value" = c(model_search_neurosynth_summary$bic, model_search_neurosynth_summary$adjr2),
                                                 "metric" = c(rep("bic", 13), rep("adjr2", 13)))

metric_labels <- as_labeller(c(bic="BIC", adjr2="R^2"), default = label_parsed)

neurosynth_all_model_results_plot <-
  ggplot(
  data = model_search_neurosynth_summary_df, 
  aes(x = predictors, 
      y = value,
      color = metric)) +
  geom_point(show.legend = F, alpha = 1, size = 3) + 
  geom_line(show.legend = F, size = 1.5) +
  xlab("Number of SC predictors") +
  ylab("Value") +
  facet_wrap(~ metric, scales = "free", labeller = metric_labels) +
  theme_classic() +
  theme(axis.text = element_text(size = 20),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        strip.background = element_blank(),
        strip.text = element_text(size=25)) 

ggsave("../figures/subplots/supp_neurosynth_all_model_results.png", 
       plot = neurosynth_all_model_results_plot,
       width = 2500,
       height = 1000,
       units = "px")

#which.min(model_search_neurosynth_summary$bic)
#which.max(model_search_neurosynth_summary$adjr2)
#model_search_neurosynth_summary$outmat
#names(model_search_neurosynth_summary$which[10,])[model_search_neurosynth_summary$which[10,]]
```

```{r}
# Supplementary
# Linear model selection by exhaustive search for FC rsfMRI
model_search_rsfmri <- regsubsets(FC_rsfMRI ~ ., data = fc_sc_df_rsfmri, nvmax = 13)
model_search_rsfmri_summary <- summary(model_search_rsfmri)

model_search_rsfmri_summary_df <- data.frame("predictors" = c(1:13, 1:13),
                                              "value" = c(model_search_rsfmri_summary$bic, model_search_rsfmri_summary$adjr2),
                                              "metric" = c(rep("bic", 13), rep("adjr2", 13)))

metric_labels <- as_labeller(c(bic="BIC", adjr2="R^2"), default = label_parsed)

rsfmri_all_model_results_plot <-
  ggplot(
  data = model_search_rsfmri_summary_df, 
  aes(x = predictors, 
      y = value,
      color = metric)) +
  geom_point(show.legend = F, alpha = 1, size = 3) + 
  geom_line(show.legend = F, size = 1.5) +
  xlab("Number of SC predictors") +
  ylab("Value") +
  facet_wrap(~ metric, scales = "free", labeller = metric_labels) +
  theme_classic() +
  theme(axis.text = element_text(size = 20),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        strip.background = element_blank(),
        strip.text = element_text(size=25)) 

ggsave("../figures/subplots/supp_rsfmri_all_model_results.png", 
       plot = rsfmri_all_model_results_plot,
       width = 2500,
       height = 1000,
       units = "px")

#which.min(model_search_rsfmri_summary$bic)
#which.max(model_search_rsfmri_summary$adjr2)
#model_search_rsfmri_summary$outmat
#names(model_search_rsfmri_summary$which[10,])[model_search_rsfmri_summary$which[10,]]
```

```{r}
# Supplementary
# Linear model selection by exhaustive search for FC NeuroQuery
model_search_neuroquery <- regsubsets(FC_Neuroquery ~ ., data = fc_sc_df_neuroquery, nvmax = 13)
model_search_neuroquery_summary <- summary(model_search_neuroquery)

model_search_neuroquery_summary_df <- data.frame("predictors" = c(1:13, 1:13),
                                                 "value" = c(model_search_neuroquery_summary$bic, model_search_neuroquery_summary$adjr2),
                                                 "metric" = c(rep("bic", 13), rep("adjr2", 13)))

metric_labels <- as_labeller(c(bic="BIC", adjr2="R^2"), default = label_parsed)

neuroquery_all_model_results_plot <-
  ggplot(
  data = model_search_neuroquery_summary_df, 
  aes(x = predictors, 
      y = value,
      color = metric)) +
  geom_point(show.legend = F, alpha = 1, size = 3) + 
  geom_line(show.legend = F, size = 1.5) +
  xlab("Number of SC predictors") +
  ylab("Value") +
  facet_wrap(~ metric, scales = "free", labeller = metric_labels) +
  theme_classic() +
  theme(axis.text = element_text(size = 20),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        strip.background = element_blank(),
        strip.text = element_text(size=25)) 

ggsave("../figures/subplots/supp_neuroquery_all_model_results.png", 
       plot = neuroquery_all_model_results_plot,
       width = 2500,
       height = 1000,
       units = "px")

#which.min(model_search_neuroquery_summary$bic)
#which.max(model_search_neuroquery_summary$adjr2)
#model_search_neuroquery_summary$outmat
#names(model_search_neuroquery_summary$which[10,])[model_search_neuroquery_summary$which[13,]]
```

```{r}
# Figure 2E
# MSE and Mean R2 OOS across 10 CV folds for linear models with varying numbers of SC predictors
folds_parcelsplit_df <- read.csv("../data/connectivity/cv_splits_parcelwise.csv")

predict.regsubsets <- function(object, newdata, id, ...) {
  form <- as.formula(object[["call"]][[2]])
  mat <- model.matrix(form, newdata)
  coefi <- coef(object, id = id)
  xvars <- names(coefi)
  # Matrix
  pred_mat <- mat[, xvars] %*% coefi
  # Vector
  pred <- as.numeric(pred_mat)
  names(pred) <- rownames(mat)
  pred
}

# Neuroquery
cv_mse_neuroquery <- matrix(NA, 10, 13, dimnames = list(NULL, paste(1:13)))
cv_adjr2oos_neuroquery <- matrix(NA, 10, 13, dimnames = list(NULL, paste(1:13)))
for (i in 1:10){ # for each cv fold
  best_subset <- regsubsets(FC_Neuroquery ~ ., fc_sc_df_neuroquery[which(folds_parcelsplit_df[,i] == "train"), ], nvmax = 13)
  for (j in 1:13){ # for each i-number-SC predictors
    pred_x <- predict.regsubsets(best_subset, fc_sc_df_neuroquery[which(folds_parcelsplit_df[,i] == "test"), ], id = j)
    cv_mse <- mean((fc_sc_df_neuroquery$FC_Neuroquery[which(folds_parcelsplit_df[,i] == "test")] - pred_x)^2)
    n <- length(fc_sc_df_neuroquery$FC_Neuroquery[which(folds_parcelsplit_df[,i] == "test")])
    margVar <- var(fc_sc_df_neuroquery$FC_Neuroquery[which(folds_parcelsplit_df[,i] == "test")])
    mst <- (n+1)/n*margVar
    cv_r2oos <- 1 - cv_mse/mst
    cv_adjr2oos <- 1 - ((1 - cv_r2oos)*(n - 1))/(n - j - 1)
    cv_mse_neuroquery[i,j] <- cv_mse
    cv_adjr2oos_neuroquery[i,j] <- cv_adjr2oos
  }
}
cv_mse_neuroquery_df <- data.frame("Value" = c(cv_mse_neuroquery),
                                   "num_predictors" = rep(c(1:13), each = 10))
cv_mse_neuroquery_stats_df <- summarySE(cv_mse_neuroquery_df, measurevar = "Value", groupvars = c("num_predictors"))
cv_adjr2oos_neuroquery_df <- data.frame("Value" = c(cv_adjr2oos_neuroquery),
                                        "num_predictors" = rep(c(1:13), each = 10))
cv_adjr2oos_neuroquery_stats_df <- summarySE(cv_adjr2oos_neuroquery_df, measurevar = "Value", groupvars = c("num_predictors"))


# Neurosynth
cv_mse_neurosynth <- matrix(NA, 10, 13, dimnames = list(NULL, paste(1:13)))
cv_adjr2oos_neurosynth <- matrix(NA, 10, 13, dimnames = list(NULL, paste(1:13)))
for (i in 1:10){ # for each cv fold
  best_subset <- regsubsets(FC_Neurosynth ~ ., fc_sc_df_neurosynth[which(folds_parcelsplit_df[,i] == "train"), ], nvmax = 13)
  for (j in 1:13){ # for each i-number-SC predictors
    pred_x <- predict.regsubsets(best_subset, fc_sc_df_neurosynth[which(folds_parcelsplit_df[,i] == "test"), ], id = j)
    cv_mse <- mean((fc_sc_df_neurosynth$FC_Neurosynth[which(folds_parcelsplit_df[,i] == "test")] - pred_x)^2)
    n <- length(fc_sc_df_neurosynth$FC_Neurosynth[which(folds_parcelsplit_df[,i] == "test")])
    margVar <- var(fc_sc_df_neurosynth$FC_Neurosynth[which(folds_parcelsplit_df[,i] == "test")])
    mst <- (n+1)/n*margVar
    cv_r2oos <- 1 - cv_mse/mst
    cv_adjr2oos <- 1 - ((1 - cv_r2oos)*(n - 1))/(n - j - 1)
    cv_mse_neurosynth[i,j] <- cv_mse
    cv_adjr2oos_neurosynth[i,j] <- cv_adjr2oos
  }
}
cv_mse_neurosynth_df <- data.frame("Value" = c(cv_mse_neurosynth),
                                   "num_predictors" = rep(c(1:13), each = 10))
cv_mse_neurosynth_stats_df <- summarySE(cv_mse_neurosynth_df, measurevar = "Value", groupvars = c("num_predictors"))
cv_adjr2oos_neurosynth_df <- data.frame("Value" = c(cv_adjr2oos_neurosynth),
                                        "num_predictors" = rep(c(1:13), each = 10))
cv_adjr2oos_neurosynth_stats_df <- summarySE(cv_adjr2oos_neurosynth_df, measurevar = "Value", groupvars = c("num_predictors"))


# rsfMRI
cv_mse_rsfmri <- matrix(NA, 10, 13, dimnames = list(NULL, paste(1:13)))
cv_adjr2oos_rsfmri <- matrix(NA, 10, 13, dimnames = list(NULL, paste(1:13)))
for (i in 1:10){ # for each cv fold
  best_subset <- regsubsets(FC_rsfMRI ~ ., fc_sc_df_rsfmri[which(folds_parcelsplit_df[,i] == "train"), ], nvmax = 13)
  for (j in 1:13){ # for each i-number-SC predictors
    pred_x <- predict.regsubsets(best_subset, fc_sc_df_rsfmri[which(folds_parcelsplit_df[,i] == "test"), ], id = j)
    cv_mse <- mean((fc_sc_df_rsfmri$FC_rsfMRI[which(folds_parcelsplit_df[,i] == "test")] - pred_x)^2)
    n <- length(fc_sc_df_rsfmri$FC_rsfMRI[which(folds_parcelsplit_df[,i] == "test")])
    margVar <- var(fc_sc_df_rsfmri$FC_rsfMRI[which(folds_parcelsplit_df[,i] == "test")])
    mst <- (n+1)/n*margVar
    cv_r2oos <- 1 - cv_mse/mst
    cv_adjr2oos <- 1 - ((1 - cv_r2oos)*(n - 1))/(n - j - 1)
    cv_mse_rsfmri[i,j] <- cv_mse
    cv_adjr2oos_rsfmri[i,j] <- cv_adjr2oos
  }
}
cv_mse_rsfmri_df <- data.frame("Value" = c(cv_mse_rsfmri),
                               "num_predictors" = rep(c(1:13), each = 10))
cv_mse_rsfmri_stats_df <- summarySE(cv_mse_rsfmri_df, measurevar = "Value", groupvars = c("num_predictors"))
cv_adjr2oos_rsfmri_df <- data.frame("Value" = c(cv_adjr2oos_rsfmri),
                                     "num_predictors" = rep(c(1:13), each = 10))
cv_adjr2oos_rsfmri_stats_df <- summarySE(cv_adjr2oos_rsfmri_df, measurevar = "Value", groupvars = c("num_predictors"))

# Combine results MSE and R2 for Neuroquery, Neurosynth, rsfMRI
cv_mse_adjr2oos_neuroquery_stats_df <- rbind(cv_mse_neuroquery_stats_df, cv_adjr2oos_neuroquery_stats_df)
cv_mse_adjr2oos_neuroquery_stats_df$metric <- rep(c("mse", "adjr2oos"), each = 13)

cv_mse_adjr2oos_neurosynth_stats_df <- rbind(cv_mse_neurosynth_stats_df, cv_adjr2oos_neurosynth_stats_df)
cv_mse_adjr2oos_neurosynth_stats_df$metric <- rep(c("mse", "adjr2oos"), each = 13)

cv_mse_adjr2oos_rsfmri_stats_df <- rbind(cv_mse_rsfmri_stats_df, cv_adjr2oos_rsfmri_stats_df)
cv_mse_adjr2oos_rsfmri_stats_df$metric <- rep(c("mse", "adjr2oos"), each = 13)

metric_labels <- as_labeller(c(mse="MSE[10-fold-CV]", adjr2oos="R[OOS-10-fold-CV]^2"), default = label_parsed)

# Neuroquery plot
neuroquery_cv_model_results_plot <-
  ggplot(
  data = cv_mse_adjr2oos_neuroquery_stats_df, 
  aes(x = num_predictors, 
      y = Value,
      color = metric)) +
  geom_point(show.legend = F, alpha = 1, size = 3) + 
  geom_line(show.legend = F, size = 1.5) +
  geom_errorbar(aes(ymin = Value-se, ymax = Value+se), width = 0.2,
               position=position_dodge(0.9)) +
  xlab("Number of SC predictors") +
  ylab("Value") +
  facet_wrap(~ metric, scales = "free", labeller = metric_labels) +
  guides(color = "none") +
  theme_classic() +
  theme(axis.text = element_text(size = 20),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        strip.background = element_blank(),
        strip.text = element_text(size=25)) 

neuroquery_cv_model_results_plot

ggsave("../figures/subplots/fig4_neuroquery_cv_model_results.png", 
       plot = neuroquery_cv_model_results_plot,
       width = 2500,
       height = 1000,
       units = "px")

# Neurosynth plot
neurosynth_cv_model_results_plot <-
  ggplot(
  data = cv_mse_adjr2oos_neurosynth_stats_df, 
  aes(x = num_predictors, 
      y = Value,
      color = metric)) +
  geom_point(show.legend = F, alpha = 1, size = 3) + 
  geom_line(show.legend = F, size = 1.5) +
  geom_errorbar(aes(ymin = Value-se, ymax = Value+se), width = 0.2,
               position=position_dodge(0.9)) +
  xlab("Number of SC predictors") +
  ylab("Value") +
  facet_wrap(~ metric, scales = "free", labeller = metric_labels) +
  guides(color = "none") +
  theme_classic() +
  theme(axis.text = element_text(size = 20),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        strip.background = element_blank(),
        strip.text = element_text(size=25)) 

neurosynth_cv_model_results_plot

ggsave("../figures/subplots/fig4_neurosynth_cv_model_results.png", 
       plot = neurosynth_cv_model_results_plot,
       width = 2500,
       height = 1000,
       units = "px")

# rsfMRI plot
rsfmri_cv_model_results_plot <-
  ggplot(
  data = cv_mse_adjr2oos_rsfmri_stats_df, 
  aes(x = num_predictors, 
      y = Value,
      color = metric)) +
  geom_point(show.legend = F, alpha = 1, size = 3) + 
  geom_line(show.legend = F, size = 1.5) +
  geom_errorbar(aes(ymin = Value-se, ymax = Value+se), width = 0.2,
               position=position_dodge(0.9)) +
  xlab("Number of SC predictors") +
  ylab("Value") +
  facet_wrap(~ metric, scales = "free", labeller = metric_labels) +
  guides(color = "none") +
  theme_classic() +
  theme(axis.text = element_text(size = 20),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        strip.background = element_blank(),
        strip.text = element_text(size=25)) 

rsfmri_cv_model_results_plot

ggsave("../figures/subplots/fig4_rsfmri_cv_model_results.png", 
       plot = rsfmri_cv_model_results_plot,
       width = 2500,
       height = 1000,
       units = "px")
```


# Figure 3

```{r}
# Create new dataframe for structure-function (SF) by parcel
# rsq = R squared value of optimal linear model testing how FC is explained by SC
# Let's first do a linear model predicting FC derived from NeuroQuery
rsq_neuroquery_by_parcel <- c()
for (i in 1:696){
  rsq_neuroquery_by_parcel[i] <- summary(lm(FC_Neuroquery ~ 
                                              SC_Coswei +
                                              SC_Eucl_dist,
                                 data = fc_sc_df[fc_sc_df$Parcel_A_ID == i | fc_sc_df$Parcel_B_ID == i, ]))$adj.r.squared
}
sf_df <- data.frame("parcel" = parcel_dict$Name, "rsq_neuroquery" = rsq_neuroquery_by_parcel)
#max(sf_df$rsq_neuroquery)

# Now let's do a linear model predicting FC derived from Neurosynth
sf_df$rsq_neurosynth <- NA
rsq_by_parcel <- c()
for (i in 1:696){
  sf_df$rsq_neurosynth[i] <- summary(lm(FC_Neurosynth ~ 
                                         SC_Coswei +
                                         SC_FGwei +
                                         SC_NavplMS,
                                       data = fc_sc_df[fc_sc_df$Parcel_A_ID == i | fc_sc_df$Parcel_B_ID == i, ]))$adj.r.squared
}
#max(sf_df$rsq_neurosynth)

# Now let's do a linear model predicting FC derived from rsfMRI
sf_df$rsq_rsfmri <- NA
for (i in 1:696){
  sf_df$rsq_rsfmri[i] <- summary(lm(FC_rsfMRI ~ 
                                      SC_Coswei +
                                      SC_Eucl_dist +
                                      SC_FGwei,
                                      data = fc_sc_df[fc_sc_df$Parcel_A_ID == i | fc_sc_df$Parcel_B_ID == i, ]))$adj.r.squared
}
#max(sf_df$rsq_rsfmri)
```


## Figure 3A

```{r}
# Figure 3A
# Plot R squared (measure of SF strength) by parcel (using rsfMRI FC)
sf_rsq_colors_rsfmri <- get_rgb_lmu_for_parcel_values(parcel_values = sf_df$rsq_rsfmri,
                                                      lower_bound_color = c(0, 0, 255), 
                                                      middle_bound_color = c(255, 255, 255), 
                                                      upper_bound_color = c(255, 0, 0),
                                                      legend = TRUE,
                                                      legend_title = bquote("SF"~R^2),
                                                      legend_values = TRUE)


sf_rsq_fig_rsfmri <- plot_brain_map(R_values = sf_rsq_colors_rsfmri[[1]]$R,
                                    G_values = sf_rsq_colors_rsfmri[[1]]$G,
                                    B_values = sf_rsq_colors_rsfmri[[1]]$B,
                                    legend_figure = sf_rsq_colors_rsfmri[[2]],
                                    )

ggsave("../figures/subplots/fig3_sf_rsq_rsfmri.png", 
       plot = sf_rsq_fig_rsfmri,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 3B

```{r}
# Plot R squared (measure of SF strength) by parcel (using NeuroQuery FC)
sf_rsq_colors_neuroquery <- get_rgb_lmu_for_parcel_values(parcel_values = sf_df$rsq_neuroquery,
                                                          lower_bound_color = c(0, 0, 255), 
                                                          middle_bound_color = c(255, 255, 255), 
                                                          upper_bound_color = c(255, 0, 0),
                                                          legend = TRUE,
                                                          legend_title = bquote("SF"~R^2),
                                                          legend_values = TRUE)

sf_rsq_fig_neuroquery <- plot_brain_map(R_values = sf_rsq_colors_neuroquery[[1]]$R,
                                        G_values = sf_rsq_colors_neuroquery[[1]]$G,
                                        B_values = sf_rsq_colors_neuroquery[[1]]$B,
                                        legend_figure = sf_rsq_colors_neuroquery[[2]],
                                        )

sf_rsq_fig_neuroquery

ggsave("../figures/subplots/fig3_sf_rsq_neuroquery.png", 
       plot = sf_rsq_fig_neuroquery,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 3C

```{r}
# Plot R squared (measure of SF strength) by parcel (using Neurosynth FC)
sf_rsq_colors_neurosynth <- get_rgb_lmu_for_parcel_values(parcel_values = sf_df$rsq_neurosynth,
                                                          lower_bound_color = c(0, 0, 255), 
                                                          middle_bound_color = c(255, 255, 255), 
                                                          upper_bound_color = c(255, 0, 0),
                                                          legend = TRUE,
                                                          legend_title = bquote("SF"~R^2),
                                                          legend_values = TRUE)

sf_rsq_fig_neurosynth <- plot_brain_map(R_values = sf_rsq_colors_neurosynth[[1]]$R,
                                        G_values = sf_rsq_colors_neurosynth[[1]]$G,
                                        B_values = sf_rsq_colors_neurosynth[[1]]$B,
                                        legend_figure = sf_rsq_colors_neurosynth[[2]],
                                        )

sf_rsq_fig_neurosynth

ggsave("../figures/subplots/fig3_sf_rsq_neurosynth.png", 
       plot = sf_rsq_fig_neurosynth,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 3D

```{r}
# Compute z scores for R2 values for each FC type
sf_df$rsq_neuroquery_z <- (sf_df$rsq_neuroquery - mean(sf_df$rsq_neuroquery))/sd(sf_df$rsq_neuroquery)
sf_df$rsq_neurosynth_z <- (sf_df$rsq_neurosynth - mean(sf_df$rsq_neurosynth))/sd(sf_df$rsq_neurosynth)
sf_df$rsq_rsfmri_z <- (sf_df$rsq_rsfmri - mean(sf_df$rsq_rsfmri))/sd(sf_df$rsq_rsfmri)

# Add lobe, region, gyrus columns
sf_df$lobe <- NA
sf_df$region <- NA
sf_df$gyrus <- NA
for (i in 1:nrow(sf_df)){
  sf_df$lobe[i] <- parcel_dict$Lobe[parcel_dict$Name == sf_df$parcel[i]]
  sf_df$region[i] <- parcel_dict$Region[parcel_dict$Name == sf_df$parcel[i]]
  sf_df$gyrus[i] <- parcel_dict$Gyrus[parcel_dict$Name == sf_df$parcel[i]]
}

# Get summary stats by region
sf_neuroquery_by_region_df <- summarySE(sf_df, measurevar = "rsq_neuroquery_z", groupvars = c("region"))
names(sf_neuroquery_by_region_df)[3] <- "rsq_z"
sf_neuroquery_by_region_df$fc_type <- "NeuroQuery"

sf_neurosynth_by_region_df <- summarySE(sf_df, measurevar = "rsq_neurosynth_z", groupvars = c("region"))
names(sf_neurosynth_by_region_df)[3] <- "rsq_z"
sf_neurosynth_by_region_df$fc_type <- "Neurosynth"

sf_rsfmri_by_region_df <- summarySE(sf_df, measurevar = "rsq_rsfmri_z", groupvars = c("region"))
names(sf_rsfmri_by_region_df)[3] <- "rsq_z"
sf_rsfmri_by_region_df$fc_type <- "rsfMRI"

sf_all_by_region_df <- rbind(sf_neuroquery_by_region_df, sf_neurosynth_by_region_df, sf_rsfmri_by_region_df)
sf_all_by_region_df$region <- factor(sf_all_by_region_df$region, levels = sf_rsfmri_by_region_df$region[order(sf_rsfmri_by_region_df$rsq_z, decreasing = FALSE)]) # factor by decreasing order from rsfMRI
sf_all_by_region_df$fc_type <- factor(sf_all_by_region_df$fc_type, levels = c("NeuroQuery", "Neurosynth", "rsfMRI"))

sf_all_by_region_bar <-
  ggplot(sf_all_by_region_df, 
       aes(x = region, y = rsq_z, fill = fc_type)) +
  geom_bar(position = "dodge", stat = "identity", color = "black", width = 0.75) +
  geom_errorbar(aes(ymin = rsq_z-se, ymax = rsq_z+se), width = 0.2,
               position=position_dodge(0.75)) +
  scale_y_continuous(sec.axis = dup_axis()) +
  xlab("") +
  ylab(bquote("SF"~R^2~"z-score")) +
  geom_hline(yintercept = 0, linetype = "solid", 
                color = "#4f4f4f", size = 1) +
  coord_flip() +
  labs(fill = "FC Type") +
  scale_fill_manual(values = c("#619CFF", "#00BA38", "#F8766D"), breaks = c("rsfMRI", "Neurosynth", "NeuroQuery")) +
  theme_classic() +
  theme(axis.text= element_text(size = 25),
        axis.title = element_text(size = 30),
        plot.title = element_text(size = 30, hjust = 0.5),
        legend.key.size = unit(1, 'cm'),
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size = 28), 
        legend.text = element_text(size = 30),
        legend.position = "bottom",
        legend.direction = "vertical")

sf_all_by_region_bar

ggsave("../figures/subplots/fig3_sf_all_by_region_bar.png", 
       plot = sf_all_by_region_bar,
       width = 4350,
       height = 8000,
       units = "px")
```


```{r}
# Supplementary - plot raw R2 values
# Get summary stats by region
sf_neuroquery_by_region_df <- summarySE(sf_df, measurevar = "rsq_neuroquery", groupvars = c("region"))
names(sf_neuroquery_by_region_df)[3] <- "rsq"
sf_neuroquery_by_region_df$fc_type <- "NeuroQuery"

sf_neurosynth_by_region_df <- summarySE(sf_df, measurevar = "rsq_neurosynth", groupvars = c("region"))
names(sf_neurosynth_by_region_df)[3] <- "rsq"
sf_neurosynth_by_region_df$fc_type <- "Neurosynth"

sf_rsfmri_by_region_df <- summarySE(sf_df, measurevar = "rsq_rsfmri", groupvars = c("region"))
names(sf_rsfmri_by_region_df)[3] <- "rsq"
sf_rsfmri_by_region_df$fc_type <- "rsfMRI"

sf_all_by_region_df <- rbind(sf_neuroquery_by_region_df, sf_neurosynth_by_region_df, sf_rsfmri_by_region_df)
sf_all_by_region_df$region <- factor(sf_all_by_region_df$region, levels = sf_rsfmri_by_region_df$region[order(sf_rsfmri_by_region_df$rsq, decreasing = FALSE)]) # factor by decreasing order from rsfMRI
sf_all_by_region_df$fc_type <- factor(sf_all_by_region_df$fc_type, levels = c("NeuroQuery", "Neurosynth", "rsfMRI"))

sf_raw_all_by_region_bar <-
  ggplot(sf_all_by_region_df, 
       aes(x = region, y = rsq, fill = fc_type)) +
  geom_bar(position = "dodge", stat = "identity", color = "black", width = 0.75) +
  geom_errorbar(aes(ymin = rsq - se, ymax = rsq + se), width = 0.2,
               position=position_dodge(0.75)) +
  scale_y_continuous(sec.axis = dup_axis()) +
  xlab("") +
  ylab(bquote("SF"~R^2)) +
  #geom_hline(yintercept = 0, linetype = "solid", 
  #              color = "#4f4f4f", size = 1) +
  coord_flip() +
  labs(fill = "FC Type") +
  scale_fill_manual(values = c("#619CFF", "#00BA38", "#F8766D"), breaks = c("rsfMRI", "Neurosynth", "NeuroQuery")) +
  theme_classic() +
  theme(axis.text= element_text(size = 25),
        axis.title = element_text(size = 30),
        plot.title = element_text(size = 30, hjust = 0.5),
        legend.key.size = unit(1, 'cm'),
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size = 28), 
        legend.text = element_text(size = 30),
        legend.position = "bottom",
        legend.direction = "vertical")

sf_raw_all_by_region_bar

ggsave("../figures/subplots/supp_sf_raw_all_by_region_bar.png", 
       plot = sf_raw_all_by_region_bar,
       width = 4350,
       height = 8000,
       units = "px")
```


# Figure 4

## Figure 4A

Graphic demonstrating active-active connections and active-inactive connections was created in Figma.

## Figure 4B

```{r}
# Neurosynth - SC_Count
# Determine which parcels are active (i.e,. nonzero) for each functional term
active_parcels_by_term <- list()
for (i in 1:ncol(neurosynth_functional_activation_df)){
  active_parcels_by_term[[i]] <- neurosynth_functional_activation_df[,i]
  active_parcels_by_term[[i]][active_parcels_by_term[[i]] != 0] <- 1
}
# For each functional term, create a dataframe which classifies
# the activity/inactivity of the two parcels making up each pairwise connection 
term_i_analysis <- list()
for (i in 1:ncol(neurosynth_functional_activation_df)){
  svMisc::progress(i, ncol(neurosynth_functional_activation_df))
  term_i_analysis[[i]] <- fc_sc_df[,c(1:2, 6, 8, 12, 13)]
  term_i_analysis[[i]]$Parcel_A_type <- NA
  term_i_analysis[[i]]$Parcel_A_type[term_i_analysis[[i]]$Parcel_A_ID %in% which(neurosynth_functional_activation_df[,i] != 0)] <- "active"
  term_i_analysis[[i]]$Parcel_A_type[term_i_analysis[[i]]$Parcel_A_ID %in% which(neurosynth_functional_activation_df[,i] == 0)] <- "inactive"
  term_i_analysis[[i]]$Parcel_B_type <- NA
  term_i_analysis[[i]]$Parcel_B_type[term_i_analysis[[i]]$Parcel_B_ID %in% which(neurosynth_functional_activation_df[,i] != 0)] <- "active"
  term_i_analysis[[i]]$Parcel_B_type[term_i_analysis[[i]]$Parcel_B_ID %in% which(neurosynth_functional_activation_df[,i] == 0)] <- "inactive"
  term_i_analysis[[i]] <- term_i_analysis[[i]][!term_i_analysis[[i]]$Parcel_A_type == "inactive", ]
  row.names(term_i_analysis[[i]]) <- NULL
}

# Count the number of active-active parcel connections for each term
num_active_active_connections <- c()
for (i in 1:length(term_i_analysis)){
  num_active_active_connections[i] <- nrow(term_i_analysis[[i]][term_i_analysis[[i]]$Parcel_A_type == "active" & term_i_analysis[[i]]$Parcel_B_type == "active", ])
}

# Remove functional terms with less than 50 active-active parcel connections
term_i_analysis_clean <- term_i_analysis[-which(num_active_active_connections < 50)]
#term_i_analysis_clean <- term_i_analysis

# Structure-function by term analysis
# Compute proportion connected, i.e., 
# the proportion of all possible connections between the parcels activated for 
# a particular functional term that have a non-zero number of white matter (WM) streamlines. 
# Moreover, and more importantly, run a Wilcoxon test to evaluate if the # of WM tracts
# between active-active parcels is different from those between active-inactive parcels
# Store the Wilcoxon effect size, p value, and fold change
wilcox_effect_size <- c()
wilcox_p_value <- c()
fold_change <- c()
log_fold_change <- c()
mean_eucl_dist_active_active <- c()
mean_eucl_dist_active_inactive <- c()
for (i in 1:length(term_i_analysis_clean)){
  svMisc::progress(i, length(term_i_analysis_clean))
  wilcox_effect_size[i] <- as.numeric(wilcox.test(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "active"], 
            term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])$statistic/sqrt(nrow(term_i_analysis_clean[[i]])))
  wilcox_p_value[i] <- wilcox.test(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[1]]$Parcel_B_type == "active"], 
            term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])$p.value
  fold_change[i] <- mean(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "active"])/mean(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])
  log_fold_change[i] <- log10(mean(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "active"])) - log10(mean(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"]))
  mean_eucl_dist_active_active[i] <- mean(term_i_analysis_clean[[i]]$SC_Eucl_dist[(term_i_analysis_clean[[i]]$Parcel_B_type == "active")])
  mean_eucl_dist_active_inactive[i] <- mean(term_i_analysis_clean[[i]]$SC_Eucl_dist[(term_i_analysis_clean[[i]]$Parcel_B_type == "inactive")])
}

# Make dataframe for SF correspondence by term results above
# Only select terms that have a minimum of 50 active-active parcel connections
# This reduces functional terms from 334 to 314
sf_by_term_df <- data.frame("term" = colnames(neurosynth_functional_activation_df)[-which(num_active_active_connections < 50)],
                            "wilcox_effect_size" = wilcox_effect_size,
                            "wilcox_p_value" = wilcox_p_value,
                            "wilcox_adj_p_value" = length(wilcox_effect_size) * wilcox_p_value,
                            "fold_change" = fold_change,
                            "log_fold_change" = log_fold_change,
                            "mean_eucl_dist_active_active" = mean_eucl_dist_active_active,
                            "mean_eucl_dist_active_inactive" = mean_eucl_dist_active_inactive)

alpha_crit <- 0.05
fc_upper_threshold <- as.numeric(quantile(sf_by_term_df$fold_change[sf_by_term_df$wilcox_adj_p_value < alpha_crit], 0.2))
fc_lower_threshold <- fc_upper_threshold
sf_by_term_df$de_label <- NA
#sf_by_term_df$de_label <- sf_by_term_df$term
sf_by_term_df$de_label[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)] <- sf_by_term_df$term[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)]
sf_by_term_df$de_label[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)] <- sf_by_term_df$term[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)]

# Define additional variables for plotting aesthetics
sf_by_term_df$plot_label <- NA
sf_by_term_df$plot_label[sf_by_term_df$term == "sensorimotor"] <- "sensorimotor"
sf_by_term_df$plot_label[sf_by_term_df$term == "visual"] <- "visual"
sf_by_term_df$plot_label[sf_by_term_df$term == "semantic"] <- "semantic"
sf_by_term_df$plot_label[sf_by_term_df$term == "emotion"] <- "emotion"
sf_by_term_df$plot_label[sf_by_term_df$term == "prediction"] <- "prediction"
sf_by_term_df$plot_label[sf_by_term_df$term == "cognition"] <- "cognition"

sf_by_term_df$de_color <- "#BDBDBD"
sf_by_term_df$de_color[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)] <- "#F8766D"
sf_by_term_df$de_color[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)] <- "#00A9FF"

sf_by_term_df$label_color <- sf_by_term_df$de_color
sf_by_term_df$label_color[sf_by_term_df$label_color == "#00A9FF"] <- "darkblue"
sf_by_term_df$label_color[sf_by_term_df$label_color == "#F8766D"] <- "darkred"

sf_by_term_df$nudge_x <- 0
sf_by_term_df$nudge_x[sf_by_term_df$de_color == "#F8766D"] <- 0.1
sf_by_term_df$nudge_x[sf_by_term_df$term == "semantic"] <- 0.2
sf_by_term_df$nudge_x[sf_by_term_df$term == "emotion"] <- 0
sf_by_term_df$nudge_x[sf_by_term_df$term == "prediction"] <- -0.2

sf_by_term_df$nudge_y <- 1
sf_by_term_df$nudge_y[sf_by_term_df$term == "cognition"] <- -1
sf_by_term_df$nudge_y[sf_by_term_df$term == "semantic"] <- -1

# Plot fold change and p value for the Wilcoxon test
# This serves as a right-sided volcano-type plot to isolate terms
# with higher (red) and lower (blue) structure-function strength 


# Supplementary plot showing all term labels
sf_by_term_fold_p_all_plot <-
  ggplot(
  data = sf_by_term_df, 
  aes(x = log2(fold_change), 
      y = -log10(wilcox_adj_p_value),
      label = de_label)) +
        geom_point(col = sf_by_term_df$de_color, alpha = 0.5, size = 3) + 
        theme_classic() +
        geom_text_repel(col = sf_by_term_df$de_color, size = 3.5, max.overlaps = getOption("ggrepel.max.overlaps", default = 40)) +
        geom_vline(xintercept = c(log2(fc_upper_threshold)), col = "#424242", linetype = "dashed") +
        geom_vline(xintercept = c(log2(fc_lower_threshold)), col = "#424242", linetype = "dashed") +
        geom_hline(yintercept = -log10(alpha_crit), col = "#424242", linetype = "dashed") +
  xlab("log2(Fold Change)") +
  ylab("-log10(p-Value)") +
  #xlim(c(0.1, 1.48)) +
  annotate("text", x = 3.9, y = 2.5, label = paste0("p = ", alpha_crit), color = "#424242") +
  theme(axis.text = element_text(size = 16),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16))

ggsave("../figures/subplots/supp_sf_by_term_fold_p_all_neurosynth_count_plot.png", 
       plot = sf_by_term_fold_p_all_plot,
       width = 2500,
       height = 2500,
       units = "px")

# Plot for main figure with 6 select terms labeled 
sf_by_term_fold_p_plot <-
  ggplot(
  data = sf_by_term_df, 
  aes(x = log2(fold_change), 
      y = -log10(wilcox_adj_p_value),
      label = plot_label)) +
        geom_point(col = sf_by_term_df$de_color, alpha = 0.5, size = 5) + 
        theme_classic() +
        geom_text_repel(col = sf_by_term_df$label_color, size = 8, max.overlaps = getOption("ggrepel.max.overlaps", default = 50), nudge_y = sf_by_term_df$nudge_y, nudge_x = sf_by_term_df$nudge_x) +
        geom_vline(xintercept = c(log2(fc_upper_threshold)), col = "#424242", linetype = "dashed") +
        geom_vline(xintercept = c(log2(fc_lower_threshold)), col = "#424242", linetype = "dashed") +
        geom_hline(yintercept = -log10(alpha_crit), col = "#424242", linetype = "dashed") +
  xlab("log2(Fold Change)") +
  ylab("-log10(p-Value)") +
  #xlim(c(0.1, 1.48)) +
  annotate("text", x = 3.85, y = 2.5, label = paste0("p = ", alpha_crit), color = "#424242", size = 6) +
  theme(axis.text = element_text(size = 22),
        axis.title.x = element_text(colour = "black", size = 25),
        axis.title.y = element_text(colour = "black", size = 25))

ggsave("../figures/subplots/fig4_sf_by_term_fold_p_neurosynth_cos_plot.png", 
       plot = sf_by_term_fold_p_plot,
       width = 2500,
       height = 2500,
       units = "px")

# List of significant terms ordered by log(FoldChange)
# Used as table figure in Figure 4B
sf_by_term_sig_neurosynth_cos_df <- sf_by_term_df[sf_by_term_df$wilcox_adj_p_value < alpha_crit,]
sf_by_term_sig_neurosynth_cos_df <- sf_by_term_sig_neurosynth_cos_df[order(sf_by_term_sig_neurosynth_cos_df$log_fold_change, decreasing = T),]

sf_by_term_insig_neurosynth_cos_df <- sf_by_term_df[sf_by_term_df$wilcox_adj_p_value >= alpha_crit,]
sf_by_term_insig_neurosynth_cos_df <- sf_by_term_insig_neurosynth_cos_df[order(sf_by_term_insig_neurosynth_cos_df$log_fold_change, decreasing = F),]
```


## Figure 4C

```{r}
# Plot dimensionally-reduced embedding plot of functional terms
# Color by volcano quadrants of Figure 4B above
sf_by_term_embedding_df <- neurosynth_term_embedding_df[colnames(neurosynth_functional_activation_df) %in% sf_by_term_df$term, ]
#rownames(sf_by_term_embedding_df) <- colnames(neurosynth_functional_activation_df)[colnames(neurosynth_functional_activation_df) %in% sf_by_term_df$term]
# Run tSNE
# Uncommented for first run
#tsne <- Rtsne(as.matrix(sf_by_term_embedding_df), perplexity = 50, pca = TRUE, dims = 2)
#sf_by_term_tsne_df <- as.data.frame(tsne$Y)
#names(sf_by_term_tsne_df) <- c("tSNE1", "tSNE2")
#sf_by_term_tsne_df$wilcox_adj_p_value <- sf_by_term_df$wilcox_adj_p_value 
#sf_by_term_tsne_df$fold_change <- sf_by_term_df$fold_change
#sf_by_term_tsne_df$term <- sf_by_term_df$term
#sf_by_term_tsne_df$label_color <- sf_by_term_df$label_color
#sf_by_term_tsne_df$plot_label <- sf_by_term_df$plot_label
sf_by_term_tsne_df <- read.csv("../data/misc/tsne_embeddings.csv")
sf_by_term_tsne_df$de_label <- NA
sf_by_term_tsne_df$de_label[(sf_by_term_tsne_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_tsne_df$fold_change >= fc_upper_threshold)] <- sf_by_term_tsne_df$term[(sf_by_term_tsne_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_tsne_df$fold_change >= fc_upper_threshold)]
sf_by_term_tsne_df$de_label[(sf_by_term_tsne_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_tsne_df$fold_change < fc_lower_threshold)] <- sf_by_term_tsne_df$term[(sf_by_term_tsne_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_tsne_df$fold_change < fc_lower_threshold)]
sf_by_term_tsne_df$de_color <- "#BDBDBD"
sf_by_term_tsne_df$de_color[(sf_by_term_tsne_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_tsne_df$fold_change >= fc_upper_threshold)] <- "#F8766D"
sf_by_term_tsne_df$de_color[(sf_by_term_tsne_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_tsne_df$fold_change < fc_lower_threshold)] <- "#00A9FF"

sf_by_term_tsne_df$label_color <- sf_by_term_tsne_df$de_color
sf_by_term_tsne_df$label_color[sf_by_term_tsne_df$label_color == "#00A9FF"] <- "darkblue"
sf_by_term_tsne_df$label_color[sf_by_term_tsne_df$label_color == "#F8766D"] <- "darkred"

sf_by_term_tsne_df$nudge_x <- 0
sf_by_term_tsne_df$nudge_x[sf_by_term_tsne_df$de_color == "#00A9FF"] <- -3
sf_by_term_tsne_df$nudge_x[sf_by_term_tsne_df$de_color == "#F8766D"] <- 2

sf_by_term_tsne_df$plot_label <- NA
sf_by_term_tsne_df$plot_label[sf_by_term_tsne_df$term == "sensorimotor"] <- "sensorimotor"
sf_by_term_tsne_df$plot_label[sf_by_term_tsne_df$term == "visual"] <- "visual"
sf_by_term_tsne_df$plot_label[sf_by_term_tsne_df$term == "semantic"] <- "semantic"
sf_by_term_tsne_df$plot_label[sf_by_term_tsne_df$term == "emotion"] <- "emotion"
sf_by_term_tsne_df$plot_label[sf_by_term_tsne_df$term == "prediction"] <- "prediction"
sf_by_term_tsne_df$plot_label[sf_by_term_tsne_df$term == "cognition"] <- "cognition"

# Supplementary plot showing all term labels
sf_by_term_tsne_all_plot <-
  ggplot(
  data = sf_by_term_tsne_df, 
  aes(x = tSNE1, 
      y = tSNE2,
      label = de_label)) +
        geom_point(col = sf_by_term_tsne_df$de_color, alpha = 0.5, size = 4) + 
        theme_classic() +
        geom_text_repel(col = sf_by_term_tsne_df$de_color, size = 4, max.overlaps = getOption("ggrepel.max.overlaps", default = 40)) +
  xlab("tSNE1") +
  ylab("tSNE2") +
  ggtitle("Functional term embeddings") +
  theme(axis.text = element_text(size = 16),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16),
        plot.title = element_text(hjust = 0.5, size = 16))

ggsave("../figures/subplots/supp_sf_by_term_tsne_all_plot.png", 
       plot = sf_by_term_tsne_all_plot,
       width = 2500,
       height = 2500,
       units = "px")

# Supplementary plot colored by log(FoldChange)
sf_by_term_tsne_fc_plot <-
  ggplot(
  data = sf_by_term_tsne_df, 
  aes(x = tSNE1, 
      y = tSNE2,
      color = log2(fold_change))) +
        geom_point(alpha = 0.95, size = 4) + 
        theme_classic() +
  xlab("tSNE1") +
  ylab("tSNE2") +
  scale_color_gradient(low = "#00A9FF", high = "#F8766D", name = "log2(Fold Change)") +
  ggtitle("Functional term embeddings") +
  theme(axis.text = element_text(size = 22),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        plot.title = element_text(hjust = 0.5, size = 22),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))

ggsave("../figures/subplots/supp_sf_by_term_tsne_fc_plot.png", 
       plot = sf_by_term_tsne_fc_plot,
       width = 2500,
       height = 2500,
       units = "px")

# Plot for main figure with 6 select terms labeled 
sf_by_term_tsne_plot <-
  ggplot(
  data = sf_by_term_tsne_df, 
  aes(x = tSNE1, 
      y = tSNE2,
     label = plot_label)) +
        geom_point(col = sf_by_term_tsne_df$de_color, alpha = 0.5, size = 5) + 
        theme_classic() +
        geom_text_repel(col = sf_by_term_tsne_df$label_color, size = 8, max.overlaps = getOption("ggrepel.max.overlaps", default = 14)) +
  xlab("tSNE1") +
  ylab("tSNE2") +
  ggtitle("Functional term embeddings") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(colour = "black", size = 25),
        axis.title.y = element_text(colour = "black", size = 25),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 25))

sf_by_term_tsne_plot

ggsave("../figures/subplots/fig4_sf_by_term_tsne_plot.png", 
       plot = sf_by_term_tsne_plot,
       width = 2700,
       height = 2000,
       units = "px")
```


## Figure 4D

```{r}
# Plot boxplot of tSNE1 embedding across High SF and Low SF terms
sf_by_term_grouped_df <- sf_by_term_tsne_df[sf_by_term_tsne_df$de_color != "#BDBDBD",]
sf_by_term_grouped_df$sf_strength <- "High SF"
sf_by_term_grouped_df$sf_strength[sf_by_term_grouped_df$de_color == "#00A9FF"] <- "Low SF"
sf_by_term_grouped_df$sf_strength_binary <- sf_by_term_grouped_df$sf_strength
sf_by_term_grouped_df$sf_strength_binary[sf_by_term_grouped_df$sf_strength_binary == "High SF"] <- 1
sf_by_term_grouped_df$sf_strength_binary[sf_by_term_grouped_df$sf_strength_binary == "Low SF"] <- 0
sf_by_term_grouped_df$sf_strength_binary <- as.numeric(sf_by_term_grouped_df$sf_strength_binary)

wilcox_p_value_tsne1 <- sprintf("%.2e", wilcox.test(sf_by_term_grouped_df$tSNE1[sf_by_term_grouped_df$sf_strength == "High SF"], sf_by_term_grouped_df$tSNE1[sf_by_term_grouped_df$sf_strength == "Low SF"])$p.value)

# Plot tSNE1
sf_by_term_tsne1_box <-
  ggplot(sf_by_term_grouped_df, 
       aes(x = sf_strength, y = tSNE1, fill = sf_strength)) + 
  geom_boxplot(notch = T) +
  theme_classic() +
  xlab("") +
  ylab("tSNE1") +
  scale_fill_manual(values = c("#F8766D", "#00A9FF")) +
  ggtitle(paste0("p = ", wilcox_p_value_tsne1)) + 
  theme(axis.text = element_text(size = 22),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        plot.title = element_text(hjust = 0.5, size = 22)) +
  guides(fill="none")

ggsave("../figures/subplots/fig4_sf_by_term_tsne1_box.png", 
       plot = sf_by_term_tsne1_box,
       width = 1250,
       height = 2500,
       units = "px")

# Supplementary plot showing correlation between tSNE1 and log(FoldChange)
sf_by_term_tsne1_fc_line <-
  ggplot(sf_by_term_grouped_df, 
         aes(x = tSNE1, y = log2(fold_change))) + 
          geom_point(color = "#154360", size = 4, alpha = 0.7) + 
          geom_smooth(method = lm, se = FALSE, color = "red") + 
          theme_classic() +
          xlab("Functional term embeddings tSNE1") +
          ylab("log2(Fold Change)") + 
          ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(log2(fold_change) ~ tSNE1, data = sf_by_term_grouped_df))$r.squared, 2), ", p = ", sprintf("%.2e", summary(lm(log2(fold_change) ~ tSNE1, data = sf_by_term_grouped_df))$coef[2,4]))) + 
          theme(axis.text = element_text(size = 22),
                axis.title = element_text(size = 22),
                plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/supp_sf_by_term_tsne1_fc_line.png", 
       plot = sf_by_term_tsne1_fc_line,
       width = 2500,
       height = 2500,
       units = "px")
        
# Plot boxplot of PC1 embedding across High SF and Low SF terms
sf_by_term_pca_df <- prcomp(sf_by_term_embedding_df, center = TRUE, scale = TRUE)
sf_by_term_pca_coord_df <- as.data.frame(sf_by_term_pca_df$x)

sf_by_term_grouped_df$PC1 <- -1*sf_by_term_pca_coord_df$PC1[sf_by_term_tsne_df$de_color != "#BDBDBD"] # make negative for alignment with tSNE data
sf_by_term_grouped_df$PC2 <- sf_by_term_pca_coord_df$PC2[sf_by_term_tsne_df$de_color != "#BDBDBD"]

wilcox_p_value_pc1 <- sprintf("%.2e", wilcox.test(sf_by_term_grouped_df$PC1[sf_by_term_grouped_df$sf_strength == "High SF"], sf_by_term_grouped_df$PC1[sf_by_term_grouped_df$sf_strength == "Low SF"])$p.value)

# Plot PC1
sf_by_term_pc1_box <-
  ggplot(sf_by_term_grouped_df, 
       aes(x = sf_strength, y = PC1, fill = sf_strength)) + 
  geom_boxplot(notch = T) +
  theme_classic() +
  xlab("") +
  ylab("PC1") +
  scale_fill_manual(values = c("#F8766D", "#00A9FF")) +
  ggtitle(paste0("p = ", wilcox_p_value_pc1)) + 
  theme(axis.text = element_text(size = 22),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        plot.title = element_text(hjust = 0.5, size = 22)) +
  guides(fill="none")

ggsave("../figures/subplots/fig4_sf_by_term_pc1_box.png", 
       plot = sf_by_term_pc1_box,
       width = 1250,
       height = 2500,
       units = "px")

# Supplementary plot showing correlation between PC1 and log(FoldChange)
sf_by_term_pc1_fc_line <-
  ggplot(sf_by_term_grouped_df, 
         aes(x = PC1, y = log2(fold_change))) + 
          geom_point(color = "#154360", size = 4, alpha = 0.7) + 
          geom_smooth(method = lm, se = FALSE, color = "red") + 
          theme_classic() +
          xlab("Functional term embeddings PC1") +
          ylab("log2(Fold Change)") + 
          ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(log2(fold_change) ~ PC1, data = sf_by_term_grouped_df))$r.squared, 2), ", p = ", sprintf("%.2e", summary(lm(log2(fold_change) ~ PC1, data = sf_by_term_grouped_df))$coef[2,4]))) + 
          theme(axis.text = element_text(size = 22),
                axis.title = element_text(size = 22),
                plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/supp_sf_by_term_pc1_fc_line.png", 
       plot = sf_by_term_pc1_fc_line,
       width = 2500,
       height = 2500,
       units = "px")
```


## Figure 4E

```{r}
# Plot concreteness score across High SF and Low SF terms
# Concreteness dictionary from Brysbaert et al. 2014; measure of sensory-motor nature of word
sf_by_term_grouped_df$concreteness <- NA
for (i in 1:nrow(sf_by_term_grouped_df)){
  if (sf_by_term_grouped_df$term[i] %in% word_concreteness_df$Word){
    # Extract mean concreteness score from the dictionary for each term
   sf_by_term_grouped_df$concreteness[i] <- word_concreteness_df$Conc.M[word_concreteness_df$Word == sf_by_term_grouped_df$term[i]] 
  }
}

wilcox_p_value_concreteness <- sprintf("%.2e", wilcox.test(sf_by_term_grouped_df$concreteness[sf_by_term_grouped_df$sf_strength == "High SF"], sf_by_term_grouped_df$concreteness[sf_by_term_grouped_df$sf_strength == "Low SF"], exact = FALSE)$p.value)

# Plot
sf_by_term_concreteness_box <-
  ggplot(sf_by_term_grouped_df, 
       aes(x = sf_strength, y = concreteness, fill = sf_strength)) + 
  geom_boxplot(notch = T) +
  theme_classic() +
  xlab("") +
  ylab("Concreteness") +
  scale_fill_manual(values = c("#F8766D", "#00A9FF")) +
  ggtitle(paste0("p = ", wilcox_p_value_concreteness)) + 
  theme(axis.text = element_text(size = 22),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        plot.title = element_text(hjust = 0.5, size = 22)) +
  guides(fill="none")

# 10 terms out of 163 do not have concreteness values (NA); omitted

ggsave("../figures/subplots/fig4_sf_by_term_concreteness_box.png", 
       plot = sf_by_term_concreteness_box,
       width = 1250,
       height = 2500,
       units = "px")

# Supplementary plot showing correlation between concreteness and log(FoldChange)
sf_by_term_concreteness_fc_line <-
  ggplot(sf_by_term_grouped_df, 
         aes(x = concreteness, y = log2(fold_change))) + 
          geom_point(color = "#154360", size = 4, alpha = 0.7) + 
          geom_smooth(method = lm, se = FALSE, color = "red") + 
          theme_classic() +
          xlab("Concreteness (Sensory-motor) score") +
          ylab("log2(Fold Change)") + 
          ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(log2(fold_change) ~ concreteness, data = sf_by_term_grouped_df))$r.squared, 2), ", p = ", sprintf("%.2e", summary(lm(log2(fold_change) ~ concreteness, data = sf_by_term_grouped_df))$coef[2,4]))) + 
          theme(axis.text = element_text(size = 22),
                axis.title = element_text(size = 22),
                plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/supp_sf_by_term_concreteness_fc_line.png", 
       plot = sf_by_term_concreteness_fc_line,
       width = 2500,
       height = 2500,
       units = "px")
```


```{r}
# Supplementary plot demonstrating relationship between log(FoldChange) and mean Euclidean distance
sf_by_term_grouped_df$mean_eucl_dist_active_active <- NA
sf_by_term_grouped_df$mean_eucl_dist_active_inactive <- NA
for (i in 1:nrow(sf_by_term_grouped_df)){
  sf_by_term_grouped_df$mean_eucl_dist_active_active[i] <- sf_by_term_df$mean_eucl_dist_active_active[sf_by_term_df$term == sf_by_term_grouped_df$term[i]]
  sf_by_term_grouped_df$mean_eucl_dist_active_inactive[i] <- sf_by_term_df$mean_eucl_dist_active_inactive[sf_by_term_df$term == sf_by_term_grouped_df$term[i]]
}
sf_by_term_eucldist_fc_line <-
  ggplot(sf_by_term_grouped_df, 
         aes(x = mean_eucl_dist_active_active, y = log2(fold_change))) + 
          geom_point(color = "#154360", size = 4, alpha = 0.7) + 
          geom_smooth(method = lm, se = FALSE, color = "red") + 
          theme_classic() +
          xlab("Mean Euclidean distance between active parcels") +
          ylab("log2(Fold Change)") + 
          ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(log2(fold_change) ~ mean_eucl_dist_active_active, data = sf_by_term_grouped_df))$r.squared, 2), ", p = ", round(summary(lm(log2(fold_change) ~ mean_eucl_dist_active_active, data = sf_by_term_grouped_df))$coef[2,4], 2))) + 
          theme(axis.text = element_text(size = 22),
                axis.title = element_text(size = 22),
                plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/supp_sf_by_term_eucldist_fc_line.png", 
       plot = sf_by_term_eucldist_fc_line,
       width = 2500,
       height = 2500,
       units = "px")
```


## Figure 4F

Refer to Jupyter notebook `generate_ml_models_for_sf_by_term.ipynb` for generating dataframe for SVM (classification) and dataframe for DNN (regression). R code below plots results. 

```{r}
# Plot SVM binary classification results
sf_prediction_svm_df <- read.csv("../data/misc/sf_prediction_svm_results.csv")

sf_prediction_svm_results_line <-
  ggplot(sf_prediction_svm_df, 
         aes(x = mean_fpr, y = mean_tpr)) + 
          geom_line(color = "darkgreen", linewidth = 2, alpha = 1) + 
          geom_abline(slope = 1, intercept = 0, color = "black", linetype = "dashed", linewidth = 1.2) + 
          theme_classic() +
          xlab("False Positive Rate") +
          ylab("True Positive Rate") + 
          ggtitle(paste0("AUC = ", round(sf_prediction_svm_df$mean_auc[1], 2), " ± ", round(sf_prediction_svm_df$std_auc[1], 2), "\n\nAccuracy = ", round(sf_prediction_svm_df$mean_accuracy[1], 2))) + 
          theme(axis.text = element_text(size = 22),
                axis.title = element_text(size = 22),
                plot.title = element_markdown(size = 22, hjust = 0.5))

sf_prediction_svm_results_line

ggsave("../figures/subplots/fig4_sf_prediction_svm_results_line.png", 
       plot = sf_prediction_svm_results_line,
       width = 2000,
       height = 2200,
       units = "px")
```


```{r}
# Plot DNN regression results
sf_prediction_dnn_df <- read.csv("../data/misc/sf_prediction_dnn_results.csv")
# Reorder to align terms
sf_prediction_dnn_df <- sf_prediction_dnn_df[match(round(sf_by_term_grouped_df$fold_change, 3), round(sf_prediction_dnn_df$actual_fold_change, 3)), ]
sf_prediction_dnn_df$term <- sf_by_term_grouped_df$term
sf_prediction_dnn_df$sf_strength <- sf_by_term_grouped_df$sf_strength

sf_prediction_dnn_df$color[(sf_prediction_dnn_df$sf_strength == "High SF")] <- "#F8766D"
sf_prediction_dnn_df$color[(sf_prediction_dnn_df$sf_strength == "Low SF")] <- "#00A9FF"


sf_prediction_dnn_results_line <-
  ggplot(sf_prediction_dnn_df, 
         aes(x = actual_fold_change, y = predicted_fold_change)) + 
          geom_point(color = sf_prediction_dnn_df$color, size = 5, alpha = 0.7) + 
          #geom_smooth(method = lm, se = FALSE, color = "darkgreen") + 
          geom_abline(slope = 1, intercept = 0, color = "black", linetype = "dashed", linewidth = 1.2) + 
          xlim(c(1, 6)) +
          ylim(c(1, 6)) +
          theme_classic() +
          xlab("Actual Fold Change") +
          ylab("Predicted Fold Change") + 
          ggtitle(paste0("Mean R<sup>2</sup><sub>OOS-4-fold-CV</sub> = ", round(sf_prediction_dnn_df$average_r2oos[1], 2), 
                         "\n\nSpearman r = ", round(cor.test(x = sf_prediction_dnn_df$actual_fold_change, y = sf_prediction_dnn_df$predicted_fold_change, method = "spearman", exact = FALSE)$estimate, 2), 
                         ", p = ", sprintf("%.2e", cor.test(x = sf_prediction_dnn_df$actual_fold_change, y = sf_prediction_dnn_df$predicted_fold_change, method = "spearman", exact = FALSE)$p.value))) + 
          theme(axis.text = element_text(size = 22),
                axis.title = element_text(size = 22),
                plot.title = element_markdown(size = 22, hjust = 0.5))

sf_prediction_dnn_results_line

ggsave("../figures/subplots/fig4_sf_prediction_dnn_results_line.png", 
       plot = sf_prediction_dnn_results_line,
       width = 2000,
       height = 2200,
       units = "px")
```


# Figure 5

## Figure 5A

```{r}
# Brain map of FC diffusion component #1
# Load diffusion axes computed from Python notebook 
# spectral_clustering_and_diffusion_mapping.ipynb
fc_diff_df <- read.csv("../data/connectivity/fc_diffusion.csv")
# Add to SF dataframe by parcel; scale
sf_df$fc_diff1 <- scale(fc_diff_df$fc_diff1)
sf_df$fc_diff2 <- scale(fc_diff_df$fc_diff2)

# Plot FC diffusion component #1 coordinate by parcel
fc_diff1_colors <- get_rgb_lmu_for_parcel_values(parcel_values = as.numeric(sf_df$fc_diff1),
                                                 zeroed = TRUE,
                                                 legend = TRUE,
                                                 legend_values = FALSE,
                                                 legend_title = "FC diffusion 1")


sf_fc_diff1_brain <- plot_brain_map(R_values = fc_diff1_colors[[1]]$R,
                                    G_values = fc_diff1_colors[[1]]$G,
                                    B_values = fc_diff1_colors[[1]]$B
                                    )

ggsave("../figures/subplots/fig5_sf_fc_diff1_brain.png", 
       plot = sf_fc_diff1_brain,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 5B

```{r}
# Correlation between FC diffusion component #1 and SF R squared
rsq_fc_diff1_line <- 
  ggplot(sf_df, 
         aes(x = rsq_neurosynth, y = fc_diff1)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.5) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("FC diffusion 1") + 
  ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(fc_diff1 ~ rsq_neurosynth, data = sf_df))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$fc_diff1, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig5_rsq_fc_diff1_line.png", 
       plot = rsq_fc_diff1_line,
       width = 2200,
       height = 1400,
       units = "px")
```


## Figure 5C

```{r}
# Brain map of PC1 from Neurosynth activation data
# Run PCA
pca_neurosynth_results <- prcomp(neurosynth_functional_activation_df, center = TRUE)
# Add to SF dataframe by parcel;
sf_df$fa_pc1 <- -1*scale(pca_neurosynth_results$x[,1]) # scale and multiply by -1 to make more plot friendly

# Plot PC1 by parcel
fa_pc1_colors <- get_rgb_lmu_for_parcel_values(parcel_values = as.numeric(sf_df$fa_pc1),
                                               zeroed = TRUE,
                                               legend = TRUE,
                                               legend_values = TRUE,
                                               legend_title = "FA PC1")


sf_fa_pc1_brain <- plot_brain_map(R_values = fa_pc1_colors[[1]]$R,
                                  G_values = fa_pc1_colors[[1]]$G,
                                  B_values = fa_pc1_colors[[1]]$B
                                  )

ggsave("../figures/subplots/fig5_sf_fa_pc1_brain.png", 
       plot = sf_fa_pc1_brain,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 5D

```{r}
# Correlation between PC1 and SF R squared
rsq_fa_pc1_line <- 
  ggplot(sf_df, 
         aes(x = rsq_neurosynth, y = fa_pc1)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.5) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("FA PC1") + 
  ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(fa_pc1 ~ rsq_neurosynth, data = sf_df))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$fa_pc1, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig5_rsq_fa_pc1_line.png", 
       plot = rsq_fa_pc1_line,
       width = 2200,
       height = 1400,
       units = "px")
```


## Figure 5E

```{r}
# Brain map of functional diversity by parcel
# Functional diversity
# Get mean distance between word embeddings of nonzero functional terms for each parcel
# Compute mean distance to centroid; weight by activation score
mean_dist_centroid_emb_top10w_by_parcel <- rep(NA, nrow(neurosynth_functional_activation_df))
num_nonzero_terms_by_parcel <- rep(NA, nrow(neurosynth_functional_activation_df))
for (i in 1:nrow(neurosynth_functional_activation_df)){ # for each parcel, check nonzero zscores
  svMisc::progress(i, nrow(neurosynth_functional_activation_df))
  num_nonzero_terms_by_parcel[i] <- sum(as.numeric(neurosynth_functional_activation_df[i,]) != 0)
  #num_nonzero_terms_i <- sum(as.numeric(neurosynth_functional_activation_df[i,]) != 0)
  num_nonzero_terms_i <- 10
  #num_nonzero_terms_i <- round(sum(as.numeric(neurosynth_functional_activation_df[i,]) != 0)/2, 0)
  #num_nonzero_terms_i <- round(sum(as.numeric(neurosynth_functional_activation_df[i,]) != 0)/4, 0)
  nonzero_terms_weights_i <- sort(as.numeric(neurosynth_functional_activation_df[i,]), decreasing = TRUE)[1:num_nonzero_terms_i]
  centroid_i_coord <- colMeans(as.matrix(neurosynth_term_embedding_df[order(as.numeric(neurosynth_functional_activation_df[i,]), decreasing = TRUE)[1:num_nonzero_terms_i], ]))
  mean_dist_centroid_emb_top10w_by_parcel[i] <- weighted.mean(as.matrix(dist(rbind(neurosynth_term_embedding_df[order(as.numeric(neurosynth_functional_activation_df[i,]), decreasing = TRUE)[1:num_nonzero_terms_i], ], centroid_i_coord), method = "euclidean"))[(num_nonzero_terms_i+1),c(1:num_nonzero_terms_i)], nonzero_terms_weights_i)
}

#hist(num_nonzero_terms_by_parcel)
#num_nonzero_terms_by_parcel[num_nonzero_terms_by_parcel < 10]
#max(num_nonzero_terms_by_parcel)

sf_df$func_div <- scale(mean_dist_centroid_emb_top10w_by_parcel)

# Plot functional diversity by parcel
func_div_colors <- get_rgb_lmu_for_parcel_values(parcel_values = as.numeric(sf_df$func_div),
                                               zeroed = TRUE,
                                               legend = TRUE,
                                               legend_values = FALSE,
                                               legend_title = "Functional diversity")

sf_func_div_brain <- plot_brain_map(R_values = func_div_colors[[1]]$R,
                                    G_values = func_div_colors[[1]]$G,
                                    B_values = func_div_colors[[1]]$B
                                    )

sf_func_div_brain

ggsave("../figures/subplots/fig5_sf_func_div_brain.png", 
       plot = sf_func_div_brain,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 5F

```{r}
# Correlation between functional diversity and SF R squared
rsq_func_div_line <- 
  ggplot(sf_df, 
         aes(x = rsq_neurosynth, y = func_div)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.5) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("Functional diversity") + 
  ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(func_div ~ rsq_neurosynth, data = sf_df))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$func_div, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig5_rsq_func_div_line.png", 
       plot = rsq_func_div_line,
       width = 2200,
       height = 1400,
       units = "px")
```


## Figure 5G

```{r}
# Brain map of concreteness (sensory-motor score) by parcel
# Compute mean concreteness score for top 10 functional terms for each parcel
concreteness_mean_top10w_by_parcel <- rep(NA, nrow(neurosynth_functional_activation_df))
for (i in 1:nrow(neurosynth_functional_activation_df)){ # for each parcel, check nonzero zscores
  nonzero_top10_terms_i <- colnames(neurosynth_functional_activation_df[,order(as.numeric(neurosynth_functional_activation_df[i,]), decreasing = TRUE)[1:10]])
  nonzero_terms_weights_i <- sort(as.numeric(neurosynth_functional_activation_df[i,]), decreasing = TRUE)[1:10]
  concreteness_mean_top10w_by_parcel[i] <- weighted.mean(word_concreteness_df$Conc.M[which(word_concreteness_df$Word %in% nonzero_top10_terms_i)], nonzero_terms_weights_i[which(nonzero_top10_terms_i %in% word_concreteness_df$Word)])
}

sf_df$concreteness <- scale(concreteness_mean_top10w_by_parcel)

# Plot concreteness by parcel
concreteness_colors <- get_rgb_lmu_for_parcel_values(parcel_values = as.numeric(sf_df$concreteness),
                                                     zeroed = TRUE,
                                                     legend = TRUE,
                                                     legend_values = FALSE,
                                                     legend_title = "Concreteness")

sf_concreteness_brain <- plot_brain_map(R_values = concreteness_colors[[1]]$R,
                                        G_values = concreteness_colors[[1]]$G,
                                        B_values = concreteness_colors[[1]]$B
                                        )

ggsave("../figures/subplots/fig5_sf_concreteness_brain.png", 
       plot = sf_concreteness_brain,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 5H

```{r}
# Correlation between sensory-motor score (concreteness) and SF R squared
rsq_concreteness_line <- 
  ggplot(sf_df, 
         aes(x = rsq_neurosynth, y = concreteness)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.5) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("Concreteness") + 
  ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(concreteness ~ rsq_neurosynth, data = sf_df))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$concreteness, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig5_rsq_concreteness_line.png", 
       plot = rsq_concreteness_line,
       width = 2200,
       height = 1400,
       units = "px")
```


## Figure 5I

```{r, warning = F}
# Turn off warnings for this chunk; dataframe conversion produces unnecessary warning

# Brain map of extent of perceptual function in each parcel
nonzero_top10_terms_by_parcel <- list()
nonzero_top10_term_weights_by_parcel <- list()
# Initialize vectors for storing scores of words that are in specific LIWC semantic categories by parcel
affect_percent_w_by_parcel <- c(NA, 690)
social_percent_w_by_parcel <- c(NA, 690)
cogproc_percent_w_by_parcel <- c(NA, 690)
percept_percent_w_by_parcel <- c(NA, 690)
bio_percent_w_by_parcel <- c(NA, 690)
drives_percent_w_by_parcel <- c(NA, 690)
relativ_percent_w_by_parcel <- c(NA, 690)

for (i in 1:nrow(neurosynth_functional_activation_df)){ # for each parcel
  svMisc::progress(i, nrow(neurosynth_functional_activation_df))
  # Get nonzero terms
  nonzero_top10_terms_by_parcel[[i]] <- colnames(neurosynth_functional_activation_df[,order(as.numeric(neurosynth_functional_activation_df[i,]), decreasing = TRUE)[1:10]])
  # Get nonzero weights
  nonzero_top10_term_weights_by_parcel[[i]] <- sort(as.numeric(neurosynth_functional_activation_df[i,]), decreasing = TRUE)[1:10]
  affect_percent_w_by_term <- c(NA, 10)
  social_percent_w_by_term <- c(NA, 10)
  cogproc_percent_w_by_term <- c(NA, 10)
  percept_percent_w_by_term <- c(NA, 10)
  bio_percent_w_by_term <- c(NA, 10)
  drives_percent_w_by_term <- c(NA, 10)
  relativ_percent_w_by_term <- c(NA, 10)
  for (j in 1:10){ # for each term
      # Get LIWC categorization (binary) for the terms of interest 
      # Semantic categorization from Linguistic Inquiry and Word Count (Pennebaker)
      liwc_analysis_by_parcel_by_term <- as.data.frame(dfm(nonzero_top10_terms_by_parcel[[i]][j], dictionary = liwc2015dict))
      affect_percent_w_by_term[j] <- liwc_analysis_by_parcel_by_term$affect * nonzero_top10_term_weights_by_parcel[[i]][j]
      social_percent_w_by_term[j] <- liwc_analysis_by_parcel_by_term$social * nonzero_top10_term_weights_by_parcel[[i]][j]
      cogproc_percent_w_by_term[j] <- liwc_analysis_by_parcel_by_term$cogproc * nonzero_top10_term_weights_by_parcel[[i]][j]
      percept_percent_w_by_term[j] <- liwc_analysis_by_parcel_by_term$percept * nonzero_top10_term_weights_by_parcel[[i]][j]
      bio_percent_w_by_term[j] <- liwc_analysis_by_parcel_by_term$bio * nonzero_top10_term_weights_by_parcel[[i]][j]
      drives_percent_w_by_term[j] <- liwc_analysis_by_parcel_by_term$drives * nonzero_top10_term_weights_by_parcel[[i]][j]
      relativ_percent_w_by_term[j] <- liwc_analysis_by_parcel_by_term$relativ * nonzero_top10_term_weights_by_parcel[[i]][j]
  }
  affect_percent_w_by_parcel[i] <- 100 * sum(affect_percent_w_by_term) / sum(nonzero_top10_term_weights_by_parcel[[i]])
  social_percent_w_by_parcel[i] <- 100 * sum(social_percent_w_by_term) / sum(nonzero_top10_term_weights_by_parcel[[i]])
  cogproc_percent_w_by_parcel[i] <- 100 * sum(cogproc_percent_w_by_term) / sum(nonzero_top10_term_weights_by_parcel[[i]])
  percept_percent_w_by_parcel[i] <- 100 * sum(percept_percent_w_by_term) / sum(nonzero_top10_term_weights_by_parcel[[i]])
  bio_percent_w_by_parcel[i] <- 100 * sum(bio_percent_w_by_term) / sum(nonzero_top10_term_weights_by_parcel[[i]])
  drives_percent_w_by_parcel[i] <- 100 * sum(drives_percent_w_by_term) / sum(nonzero_top10_term_weights_by_parcel[[i]])
  relativ_percent_w_by_parcel[i] <- 100 * sum(relativ_percent_w_by_term) / sum(nonzero_top10_term_weights_by_parcel[[i]])
}

liwc_by_parcel_analysis_df <- data.frame("affect" = affect_percent_w_by_parcel,
                                         "social" = social_percent_w_by_parcel,
                                         "cogproc" = cogproc_percent_w_by_parcel,
                                         "percept" = percept_percent_w_by_parcel,
                                         "bio" = bio_percent_w_by_parcel,
                                         "drives" = drives_percent_w_by_parcel,
                                         "relativ" = relativ_percent_w_by_parcel)
#write.csv(liwc_by_parcel_analysis_df, "../data/misc/liwc_by_parcel_analysis.csv", row.names = F)
```


```{r, warning = F}
# Add to SF dataframe; scale for aesthetic reasons
sf_df$affect <- scale(affect_percent_w_by_parcel)
sf_df$social <- scale(social_percent_w_by_parcel)
sf_df$cogproc <- scale(cogproc_percent_w_by_parcel)
sf_df$percept <- scale(percept_percent_w_by_parcel)
sf_df$bio <- scale(bio_percent_w_by_parcel)
sf_df$drives <- scale(drives_percent_w_by_parcel)
sf_df$relativ <- scale(relativ_percent_w_by_parcel)

#round(summary(lm(affect ~ rsq_neurosynth, data = sf_df))$r.squared, 2)
#round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$affect, method = "spearman", exact = FALSE)$estimate, 2)

#round(summary(lm(social ~ rsq_neurosynth, data = sf_df))$r.squared, 2)
#round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$social, method = "spearman", exact = FALSE)$estimate, 2)

#round(summary(lm(drives ~ rsq_neurosynth, data = sf_df))$r.squared, 2)
#round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$drives, method = "spearman", exact = FALSE)$estimate, 2)

#round(summary(lm(relativ ~ rsq_neurosynth, data = sf_df))$r.squared, 2)
#round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$relativ, method = "spearman", exact = FALSE)$estimate, 2)
```

```{r}
# Plot perceptual function by parcel
percept_colors <- get_rgb_lmu_for_parcel_values(parcel_values = as.numeric(sf_df$percept),
                                                zeroed = TRUE,
                                                legend = TRUE,
                                                legend_values = FALSE,
                                                legend_title = "Perceptual")

sf_percept_brain <- plot_brain_map(R_values = percept_colors[[1]]$R,
                                   G_values = percept_colors[[1]]$G,
                                   B_values = percept_colors[[1]]$B
                                   )

ggsave("../figures/subplots/fig5_sf_percept_brain.png", 
       plot = sf_percept_brain,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 5J

```{r}
# Correlation between perceptual function and SF R squared
rsq_percept_line <- 
  ggplot(sf_df, 
         aes(x = rsq_neurosynth, y = percept)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.5) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("Perceptual function") + 
  ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(percept ~ rsq_neurosynth, data = sf_df))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$percept, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig5_rsq_percept_line.png", 
       plot = rsq_percept_line,
       width = 2200,
       height = 1400,
       units = "px")
```


## Figure 5K

```{r}
# Plot cognitive function by parcel
cogproc_colors <- get_rgb_lmu_for_parcel_values(parcel_values = as.numeric(sf_df$cogproc),
                                                zeroed = TRUE,
                                                legend = TRUE,
                                                legend_values = FALSE,
                                                legend_title = "Perceptual")

sf_cogproc_brain <- plot_brain_map(R_values = cogproc_colors[[1]]$R,
                                   G_values = cogproc_colors[[1]]$G,
                                   B_values = cogproc_colors[[1]]$B
                                   )

ggsave("../figures/subplots/fig5_sf_cogproc_brain.png", 
       plot = sf_cogproc_brain,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 5L

```{r}
# Correlation between cognitive function and SF R squared
rsq_cogproc_line <- 
  ggplot(sf_df, 
         aes(x = rsq_neurosynth, y = cogproc)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.5) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("Cognitive function") + 
  ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(cogproc ~ rsq_neurosynth, data = sf_df))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$cogproc, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig5_rsq_cogproc_line.png", 
       plot = rsq_cogproc_line,
       width = 2200,
       height = 1400,
       units = "px")
```


## Figure 5M

```{r}
# Plot biological function by parcel
bio_colors <- get_rgb_lmu_for_parcel_values(parcel_values = as.numeric(sf_df$bio),
                                            zeroed = TRUE,
                                            legend = TRUE,
                                            legend_values = FALSE,
                                            legend_title = "Biological")

sf_bio_brain <- plot_brain_map(R_values = bio_colors[[1]]$R,
                               G_values = bio_colors[[1]]$G,
                               B_values = bio_colors[[1]]$B
                               )

ggsave("../figures/subplots/fig5_sf_bio_brain.png", 
       plot = sf_bio_brain,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 5N

```{r}
# Correlation between biological function and SF R squared
rsq_bio_line <- 
  ggplot(sf_df, 
         aes(x = rsq_neurosynth, y = bio)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.5) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("Biological function") + 
  ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(bio ~ rsq_neurosynth, data = sf_df))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df$rsq_neurosynth, y = sf_df$bio, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig5_rsq_bio_line.png", 
       plot = rsq_bio_line,
       width = 2200,
       height = 1400,
       units = "px")
```

```{r}
# Multicolinearity analysis
model_grad <- lm(rsq_neurosynth ~ fc_diff1 + func_div + concreteness + percept + cogproc + bio, data = sf_df)
car::vif(model_grad)
```


# Figure 6

## Figure 6A

```{r}
# Brain map of cortical thickness
# Compute cortical thickness mean across 200 healthy subjects
cort_thick_files <- list.files("../data/cortical_thickness")
# Get cortical thickness for eaech parcel for each subject
cort_thick_vec_sub <- list()
for (i in 1:length(cort_thick_files)){
  csv_sub <- read.csv(paste0("../data/cortical_thickness/",cort_thick_files[i]), header = FALSE)
  cort_thick_vec_sub[[i]] <- as.numeric(csv_sub[1,]) # the first row stores the cortical thickness in mm
}
# Compute mean across 200 subjects for the 690 parcels
cort_thick_mean <- rep(NA, length(cort_thick_vec_sub[[1]]))
for (i in 1:length(cort_thick_vec_sub[[1]])){
  cort_thick_index <- rep(NA, length(cort_thick_vec_sub))
  for (j in 1:length(cort_thick_vec_sub)){
    cort_thick_index[j] <- cort_thick_vec_sub[[j]][i]
  }
  cort_thick_mean[i] <- mean(cort_thick_index, na.rm = TRUE)
}

# Add to dataframe
# Make dataframe specific for 690-parcel-version of Yale Brain Atlas
# Note that our cortical thickness analysis does not include the 6 corpus callosum parcels
# as corpus callosum does not have cortical thickness by conventional definition
sf_df_690 <- sf_df[c(1:345, 349:693), ]
sf_df_690$cort_thick <- cort_thick_mean
```

```{r}
# Multicolinearity analysis
#model_cortthick <- lm(rsq_neurosynth ~ fc_diff1 + func_div + concreteness + percept + cogproc + bio + cort_thick, data = sf_df_690)
model_cortthick <- lm(rsq_neurosynth ~ fc_diff1 + func_div + concreteness + percept + cort_thick, data = sf_df_690)
car::vif(model_cortthick)
```


```{r}
# Load in 690-parcel-version of Yale Brain Atlas
# Yale Brain Atlas parcel dictionary
parcel_dict_690 <- read.csv("../data/atlas_690/parcel_dict.csv")
parcel_names_690 <- parcel_dict_690$Name
vertex_number_by_parcel_690 <- parcel_dict_690$Num_vertex

# Yale Brain Atlas whole brain positions and indices
atlas_whole_positions_690 <- read.csv("../data/atlas_690/atlas_whole_positions.csv")
atlas_whole_indices_690 <- read.csv("../data/atlas_690/atlas_whole_indices.csv")
# Yale Brain Atlas left hemisphere positions and indices
atlas_LH_positions_690 <- read.csv("../data/atlas_690/atlas_LH_positions.csv")
atlas_LH_indices_690 <- read.csv("../data/atlas_690/atlas_LH_indices.csv")
# Yale Brain Atlas right hemisphere positions and indices
atlas_RH_positions_690 <- read.csv("../data/atlas_690/atlas_RH_positions.csv")
atlas_RH_indices_690 <- read.csv("../data/atlas_690/atlas_RH_indices.csv")
# Yale Brain Atlas deep left hemisphere (amygdala, hippocampus, insula) positions and indices
atlas_deepLH_positions_690 <- read.csv("../data/atlas_690/atlas_deepLH_positions.csv")
atlas_deepLH_indices_690 <- read.csv("../data/atlas_690/atlas_deepLH_indices.csv")
# Yale Brain Atlas deep right hemisphere (amygdala, hippocampus, insula) positions and indices
atlas_deepRH_positions_690 <- read.csv("../data/atlas_690/atlas_deepRH_positions.csv")
atlas_deepRH_indices_690 <- read.csv("../data/atlas_690/atlas_deepRH_indices.csv")
```

```{r}
# Define plotting function needed for analysis with 690-parcel version of atlas
# Function to generate a single image of six views of Yale Brain Atlas
plot_brain_map_690 <- function(R_values = parcel_dict_690$YBA_R_color, G_values = parcel_dict_690$YBA_G_color, B_values = parcel_dict_690$YBA_B_color, plot_title = NULL, legend_figure = NULL){

  stopifnot("R_values must be a vector of length 690 containing numeric or integer values on the RGB scale from 0 to 255." = is.null(R_values) | (is.vector(R_values) & (all(is.numeric(R_values) | is.integer(R_values))) & (length(R_values) == 690) & all(R_values >= 0 & R_values <= 255)))
  stopifnot("G_values must be a vector of length 690 containing numeric or integer values on the RGB scale from 0 to 255." = is.null(G_values) | (is.vector(G_values) & (all(is.numeric(G_values) | is.integer(G_values))) & (length(G_values) == 690) & all(G_values >= 0 & G_values <= 255)))
  stopifnot("B_values must be a vector of length 690 containing numeric or integer values on the RGB scale from 0 to 255." = is.null(B_values) | (is.vector(B_values) & (all(is.numeric(B_values) | is.integer(B_values))) & (length(B_values) == 690) & all(B_values >= 0 & B_values <= 255)))
  stopifnot("plot_title must be a single character element." = is.null(plot_title) | (is.character(plot_title) & (length(plot_title) == 1)))
  stopifnot("legend_figure must be a ggplot object." = is.null(legend_figure) | is.ggplot(legend_figure))

  brain_list <- list()
  brain_list[[1]] <- plot_ly(
    type = "mesh3d",
    x = atlas_whole_positions_690$x,
    y = atlas_whole_positions_690$y,
    z = atlas_whole_positions_690$z,
    vertexcolor = rep(
      rgb(R_values/255, G_values/255, B_values/255, 1),
      vertex_number_by_parcel_690
    ),
    i = atlas_whole_indices_690$i,
    j = atlas_whole_indices_690$j,
    k = atlas_whole_indices_690$k
  ) %>%
    config(displaylogo = F, displayModeBar = F) %>%
    layout(scene = list(camera = list(
      eye = list(x = 0, y = 0, z = 1.4),
      up = list(x = 0, y = 1, z = 0),
      center = list(x = 0, y = 0, z = 0)
    ))) %>%
    layout(scene = list(xaxis = list(visible = FALSE),
                        yaxis = list(visible = FALSE),
                        zaxis = list(visible = FALSE)))

  brain_list[[2]] <- plot_ly(
    type = "mesh3d",
    x = atlas_whole_positions_690$x,
    y = atlas_whole_positions_690$y,
    z = atlas_whole_positions_690$z,
    vertexcolor = rep(
      rgb(R_values/255, G_values/255, B_values/255, 1),
      vertex_number_by_parcel_690
    ),
    i = atlas_whole_indices_690$i,
    j = atlas_whole_indices_690$j,
    k = atlas_whole_indices_690$k
  ) %>%
    config(displaylogo = F, displayModeBar = F) %>%
    layout(scene = list(camera = list(
      eye = list(x = 0, y = 0, z = -1.5),
      up = list(x = 0, y = 1, z = 0),
      center = list(x = 0, y = 0, z = 0)
    ))) %>%
    layout(scene = list(xaxis = list(visible = FALSE),
                        yaxis = list(visible = FALSE),
                        zaxis = list(visible = FALSE)))

  brain_list[[3]] <- plot_ly(
    type = "mesh3d",
    x = atlas_LH_positions_690$x,
    y = atlas_LH_positions_690$y,
    z = atlas_LH_positions_690$z,
    vertexcolor = rep(
      rgb(R_values[which(parcel_dict_690$LH == 1)]/255, G_values[which(parcel_dict_690$LH == 1)]/255, B_values[which(parcel_dict_690$LH == 1)]/255, 1), vertex_number_by_parcel_690[which(parcel_dict_690$LH == 1)]),
    opacity = 1,
    i = atlas_LH_indices_690$i,
    j = atlas_LH_indices_690$j,
    k = atlas_LH_indices_690$k
  ) %>%
    config(displaylogo = F, displayModeBar = F) %>%
    layout(scene = list(camera = list(
      eye = list(x = -1.3, y = 0, z = 0),
      up = list(x = 0, y = 0, z = 1),
      center = list(x = 0, y = 0, z = 0)
    ))) %>%
    layout(scene = list(xaxis = list(visible = FALSE),
                        yaxis = list(visible = FALSE),
                        zaxis = list(visible = FALSE)))

  brain_list[[4]] <- plot_ly(
    type = "mesh3d",
    x = atlas_LH_positions_690$x,
    y = atlas_LH_positions_690$y,
    z = atlas_LH_positions_690$z,
    vertexcolor = rep(
      rgb(R_values[which(parcel_dict_690$LH == 1)]/255, G_values[which(parcel_dict_690$LH == 1)]/255, B_values[which(parcel_dict_690$LH == 1)]/255, 1), vertex_number_by_parcel_690[which(parcel_dict_690$LH == 1)]),
    opacity = 1,
    i = atlas_LH_indices_690$i,
    j = atlas_LH_indices_690$j,
    k = atlas_LH_indices_690$k
  ) %>%
    config(displaylogo = F, displayModeBar = F) %>%
    layout(scene = list(camera = list(
      eye = list(x = 1.5, y = 0, z = 0),
      up = list(x = 0, y = 0, z = 1),
      center = list(x = 0, y = 0, z = 0)
    ))) %>%
    layout(scene = list(xaxis = list(visible = FALSE),
                        yaxis = list(visible = FALSE),
                        zaxis = list(visible = FALSE)))

  brain_list[[5]] <- plot_ly(
    type = "mesh3d",
    x = atlas_RH_positions_690$x,
    y = atlas_RH_positions_690$y,
    z = atlas_RH_positions_690$z,
    vertexcolor = rep(
      rgb(R_values[which(parcel_dict_690$RH == 1)]/255, G_values[which(parcel_dict_690$RH == 1)]/255, B_values[which(parcel_dict_690$RH == 1)]/255, 1), vertex_number_by_parcel_690[which(parcel_dict_690$RH == 1)]),
    i = atlas_RH_indices_690$i,
    j = atlas_RH_indices_690$j,
    k = atlas_RH_indices_690$k
  ) %>%
    config(displaylogo = F, displayModeBar = F) %>%
    layout(scene = list(camera = list(
      eye = list(x = 1.3, y = 0, z = 0),
      up = list(x = 0, y = 0, z = 1),
      center = list(x = 0, y = 0, z = 0)
    ))) %>%
    layout(scene = list(xaxis = list(visible = FALSE),
                        yaxis = list(visible = FALSE),
                        zaxis = list(visible = FALSE)))

  brain_list[[6]] <- plot_ly(
    type = "mesh3d",
    x = atlas_RH_positions_690$x,
    y = atlas_RH_positions_690$y,
    z = atlas_RH_positions_690$z,
    vertexcolor = rep(
      rgb((R_values[which(parcel_dict_690$RH == 1)])/255, G_values[which(parcel_dict_690$RH == 1)]/255, B_values[which(parcel_dict_690$RH == 1)]/255, 1), vertex_number_by_parcel_690[which(parcel_dict_690$RH == 1)]),
    i = atlas_RH_indices_690$i,
    j = atlas_RH_indices_690$j,
    k = atlas_RH_indices_690$k
  ) %>%
    config(displaylogo = F, displayModeBar = F) %>%
    layout(scene = list(camera = list(
      eye = list(x = -1.5, y = 0, z = 0),
      up = list(x = 0, y = 0, z = 1),
      center = list(x = 0, y = 0, z = 0)
    ))) %>%
    layout(scene = list(xaxis = list(visible = FALSE),
                        yaxis = list(visible = FALSE),
                        zaxis = list(visible = FALSE)))

  suppressWarnings(orca(brain_list[[1]], "../data/brain_map/brain1.png", width = 1500, height = 1500))
  suppressWarnings(orca(brain_list[[2]], "../data/brain_map/brain2.png", width = 1500, height = 1500))
  suppressWarnings(orca(brain_list[[3]], "../data/brain_map/brain3.png", width = 1800, height = 1300))
  suppressWarnings(orca(brain_list[[4]], "../data/brain_map/brain4.png", width = 1800, height = 1300))
  suppressWarnings(orca(brain_list[[5]], "../data/brain_map/brain5.png", width = 1800, height = 1300))
  suppressWarnings(orca(brain_list[[6]], "../data/brain_map/brain6.png", width = 1800, height = 1300))


  brain_img_1 <- readPNG("../data/brain_map/brain1.png")
  brain_img_2 <- readPNG("../data/brain_map/brain2.png")
  brain_img_3 <- readPNG("../data/brain_map/brain3.png")
  brain_img_4 <- readPNG("../data/brain_map/brain4.png")
  brain_img_5 <- readPNG("../data/brain_map/brain5.png")
  brain_img_6 <- readPNG("../data/brain_map/brain6.png")

  brain_figs <- ggplot() +
    theme_classic() +
    ggtitle(plot_title) +
    theme(plot.title = element_text(size = 20, hjust = 0.5),
          axis.line=element_blank()) +
    annotation_custom(rasterGrob(brain_img_1, width = 1, height = 1),
                      xmin = 0, xmax = 0.294,
                      ymin = 0.5, ymax = 1) +
    annotation_custom(rasterGrob(brain_img_2, width = 1, height = 1),
                      xmin = 0, xmax = 0.294,
                      ymin = 0, ymax = 0.5) +
    annotation_custom(rasterGrob(brain_img_3, width = 1, height = 1),
                      xmin = 0.294, xmax = 0.647,
                      ymin = 0.5, ymax = 0.9333) +
    annotation_custom(rasterGrob(brain_img_4, width = 1, height = 1),
                      xmin = 0.294, xmax = 0.647,
                      ymin = 0.0667, ymax = 0.5) +
    annotation_custom(rasterGrob(brain_img_5, width = 1, height = 1),
                      xmin = 0.647, xmax = 1,
                      ymin = 0.5, ymax = 0.9333) +
    annotation_custom(rasterGrob(brain_img_6, width = 1, height = 1),
                      xmin = 0.647, xmax = 1,
                      ymin = 0.0667, ymax = 0.5) +
    coord_fixed(ratio = 0.5882)

  if (!is.null(legend_figure)){
    brain_map <- ggarrange(brain_figs, legend_figure, ncol = 2, nrow = 1, widths = c(0.85, 0.15))
  } else {
    brain_map <- brain_figs
  }

  return(brain_map)
}
```


```{r}
# Plot cortical thickness by parcel
cort_thick_colors <- get_rgb_lmu_for_parcel_values(parcel_values = as.numeric(sf_df_690$cort_thick),
                                                   zeroed = FALSE,
                                                   legend = TRUE,
                                                   legend_values = TRUE,
                                                   legend_title = "mm")

sf_cort_thick_brain <- plot_brain_map_690(R_values = cort_thick_colors[[1]]$R,
                                          G_values = cort_thick_colors[[1]]$G,
                                          B_values = cort_thick_colors[[1]]$B,
                                          legend_figure = cort_thick_colors[[2]],
                                          )

ggsave("../figures/subplots/fig6_sf_cort_thick_brain.png", 
       plot = sf_cort_thick_brain,
       width = 5100,
       height = 3000,
       units = "px")
```


## Figure 6B

```{r}
# Plot relationship between cortical thickness and SF R squared (colored by axial coordinate) for all parcels
sf_df_690$mean_x <- parcel_dict_690$mean_x # sagittal
sf_df_690$mean_y <- parcel_dict_690$mean_y # coronal
sf_df_690$mean_z <- parcel_dict_690$mean_z # axial

cort_thick_rsq_line <- 
  ggplot(sf_df_690, 
         aes(x = rsq_neurosynth, y = cort_thick, color = mean_z)) + 
  geom_point(size = 3, alpha = 1) + 
  scale_color_viridis_c(name = paste0("R<sup>2</sup> = ", round(summary(lm(cort_thick ~ mean_z, data = sf_df_690))$r.squared, 2), "\n\nAxial (Z)")) +
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("Cortical thickness (mm)") + 
  ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(cort_thick ~ rsq_neurosynth, data = sf_df_690))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df_690$rsq_neurosynth, y = sf_df_690$cort_thick, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5),
        legend.key.size = unit(1, 'cm'),
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_markdown(size = 20), 
        legend.text = element_text(size = 16)) 

ggsave("../figures/subplots/fig6_cort_thick_rsq_line.png", 
       plot = cort_thick_rsq_line,
       width = 2500,
       height = 2000,
       units = "px")
```


## Figure 6C

```{r}
# Plot relationship between cortical thickness and SF R squared (colored by coronal coordinate) for just parietal lobe parcels
cort_thick_rsq_parietal_line <- 
  ggplot(sf_df_690[sf_df_690$lobe == "Parietal", ], 
         aes(x = rsq_neurosynth, y = cort_thick, color = mean_z)) + 
  geom_point(size = 3, alpha = 1) + 
  scale_color_viridis_c(name = paste0("R<sup>2</sup> = ", round(summary(lm(cort_thick ~ mean_z, data = sf_df_690[sf_df_690$lobe == "Parietal",]))$r.squared, 2), "\n\nAxial (Z)")) +
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  xlab(bquote("SF"~R^2)) +
  ylab("Cortical thickness (mm)") + 
 ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(cort_thick ~ rsq_neurosynth, data = sf_df_690[sf_df_690$lobe == "Parietal", ]))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df_690$rsq_neurosynth[sf_df_690$lobe == "Parietal"], y = sf_df_690$cort_thick[sf_df_690$lobe == "Parietal"], method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5),
        legend.key.size = unit(1, 'cm'),
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_markdown(size = 20), 
        legend.text = element_text(size = 16)) 

ggsave("../figures/subplots/fig6_cort_thick_rsq_parietal_line.png", 
       plot = cort_thick_rsq_parietal_line,
       width = 2500,
       height = 2000,
       units = "px")

round(summary(lm(fc_diff1 ~ rsq_neurosynth, data = sf_df_690[sf_df_690$lobe == "Parietal", ]))$r.squared, 2)
```


## Figure 6D

```{r}
# Plot correlation between cortical thickness and functional diffusion gradient
#cor.test(y = sf_df$fc_diff1, x = sf_df$cort_thick, method = "spearman")
cort_thick_fcdiff1_line <- 
  ggplot(sf_df_690, 
         aes(x = fc_diff1, y = cort_thick)) + 
    geom_point(color = "#154360", size = 3, alpha = 0.5) + 
    geom_smooth(method = lm, se = FALSE, color = "red") + 
    theme_classic() +
    ylab("Cortical thickness (mm)") +
    xlab("FC diffusion 1") + 
    ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(cort_thick ~ fc_diff1, data = sf_df_690))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df_690$fc_diff1, y = sf_df_690$cort_thick, method = "spearman", exact = FALSE)$estimate, 2))) + 
    theme(axis.text= element_text(size = 20),
          axis.title = element_text(size = 22),
          plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig6_cort_thick_fcdiff1_line.png", 
       plot = cort_thick_fcdiff1_line,
       width = 2000,
       height = 1500,
       units = "px")
```


## Figure 6E

```{r}
# Plot correlation between cortical thickness and functional diversity
cort_thick_func_div_line <- 
  ggplot(sf_df_690, 
         aes(x = func_div, y = cort_thick)) + 
    geom_point(color = "#154360", size = 3, alpha = 0.5) + 
    geom_smooth(method = lm, se = FALSE, color = "red") + 
    theme_classic() +
    ylab("Cortical thickness (mm)") +
    xlab("Functional diversity") + 
    ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(cort_thick ~ func_div, data = sf_df_690))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df_690$func_div, y = sf_df_690$cort_thick, method = "spearman", exact = FALSE)$estimate, 2))) + 
    theme(axis.text= element_text(size = 20),
          axis.title = element_text(size = 22),
          plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig6_cort_thick_func_div_line.png", 
       plot = cort_thick_func_div_line,
       width = 2000,
       height = 1500,
       units = "px")
```


## Figure 6F

```{r}
# Plot correlation between cortical thickness and concreteness (sensory-motor)
cort_thick_concreteness_line <- 
  ggplot(sf_df_690, 
         aes(x = concreteness, y = cort_thick)) + 
    geom_point(color = "#154360", size = 3, alpha = 0.5) + 
    geom_smooth(method = lm, se = FALSE, color = "red") + 
    theme_classic() +
    ylab("Cortical thickness (mm)") +
    xlab("Concreteness (Sensory-motor function)") + 
    ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(cort_thick ~ concreteness, data = sf_df_690))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df_690$concreteness, y = sf_df_690$cort_thick, method = "spearman", exact = FALSE)$estimate, 2))) + 
    theme(axis.text= element_text(size = 20),
          axis.title = element_text(size = 22),
          plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig6_cort_thick_concreteness_line.png", 
       plot = cort_thick_concreteness_line,
       width = 2000,
       height = 1500,
       units = "px")
```


## Figure 6G

```{r}
# Plot correlation between cortical thickness and perceptual function
cort_thick_percept_line <- 
  ggplot(sf_df_690, 
         aes(x = percept, y = cort_thick)) + 
    geom_point(color = "#154360", size = 3, alpha = 0.5) + 
    geom_smooth(method = lm, se = FALSE, color = "red") + 
    theme_classic() +
    ylab("Cortical thickness (mm)") +
    xlab("Perceptual function") + 
    ggtitle(paste0("R<sup>2</sup> = ", round(summary(lm(cort_thick ~ percept, data = sf_df_690))$r.squared, 2),
                 ", Spearman r = ",
                 round(cor.test(x = sf_df_690$percept, y = sf_df_690$cort_thick, method = "spearman", exact = FALSE)$estimate, 2))) + 
    theme(axis.text= element_text(size = 20),
          axis.title = element_text(size = 22),
          plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/fig6_cort_thick_percept_line.png", 
       plot = cort_thick_percept_line,
       width = 2000,
       height = 1500,
       units = "px")
```


# Additional supplementary figures

## Supplementary 1 

This figure was produced from `spectral_clustering_and_diffusion_mapping.ipynb` and from code chunks above.

## Supplementary 2

```{r}
# Supplementary - compare how different SC thresholding affects R2 with FC_Neuroquery
fc_sc_thresholding_df <- read.csv("../data/connectivity/fc_sc_thresholding.csv")

sc_thresholding_test_df <- data.frame("SC_type" = c(rep("SC_Count_0", 3),
                                                    rep("SC_Count_10", 3),
                                                    rep("SC_Count_30", 3),
                                                    rep("SC_Count_50", 3),
                                                    rep("SC_Count_70", 3),
                                                    rep("SC_Count_90", 3)
                                                    ),
                                      "FC_type" = rep(c("FC_Neuroquery", "FC_Neurosynth", "FC_rsfMRI"), 6),
                                      "adjR2" = NA)

for (i in 1:nrow(sc_thresholding_test_df)){
  sc_thresholding_test_df$adjR2[i] <- summary(lm(fc_sc_thresholding_df[,which(names(fc_sc_thresholding_df) == sc_thresholding_test_df$FC_type[i])] ~ fc_sc_thresholding_df[,which(names(fc_sc_thresholding_df) == sc_thresholding_test_df$SC_type[i])]))$adj.r.squared
}

sc_thresholding_test_df$SC_type_label <- sc_thresholding_test_df$SC_type
sc_thresholding_test_df$SC_type_label[sc_thresholding_test_df$SC_type_label == "SC_Count_0"] <- 0
sc_thresholding_test_df$SC_type_label[sc_thresholding_test_df$SC_type_label == "SC_Count_10"] <- 10
sc_thresholding_test_df$SC_type_label[sc_thresholding_test_df$SC_type_label == "SC_Count_30"] <- 30
sc_thresholding_test_df$SC_type_label[sc_thresholding_test_df$SC_type_label == "SC_Count_50"] <- 50
sc_thresholding_test_df$SC_type_label[sc_thresholding_test_df$SC_type_label == "SC_Count_70"] <- 70
sc_thresholding_test_df$SC_type_label[sc_thresholding_test_df$SC_type_label == "SC_Count_90"] <- 90

sc_thresholding_test_df$FC_type_label <- sc_thresholding_test_df$FC_type
sc_thresholding_test_df$FC_type_label[sc_thresholding_test_df$FC_type_label == "FC_Neuroquery"] <- "NeuroQuery"
sc_thresholding_test_df$FC_type_label[sc_thresholding_test_df$FC_type_label == "FC_Neurosynth"] <- "Neurosynth"
sc_thresholding_test_df$FC_type_label[sc_thresholding_test_df$FC_type_label == "FC_rsfMRI"] <- "rsfMRI"
sc_thresholding_test_df$FC_type_label <- factor(sc_thresholding_test_df$FC_type_label, levels = c("rsfMRI", "Neurosynth", "NeuroQuery"))

sc_thresholding_test_line <-
  ggplot(sc_thresholding_test_df, 
       aes(x = SC_type_label, y = adjR2, group = FC_type_label)) +
  geom_line(aes(color = FC_type_label), linewidth = 1.5) +
  geom_point(aes(color = FC_type_label), size = 3) +
  xlab("SC WM Count Threshold (i.e., present in >X% of subjects)") +
  ylab(bquote("SF"~R^2)) +
  labs(color = "FC Type") +
  theme_classic() +
  theme(axis.text= element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5),
        legend.key.size = unit(1, 'cm'),
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=15), 
        legend.text = element_text(size=14))

ggsave("../figures/subplots/supp_sc_thresholding_test_line.png", 
       plot = sc_thresholding_test_line,
       width = 3000,
       height = 2200,
       units = "px")
```

```{r}
# Supplementary - compare how different weighting of SC affects R2 with FC_Neuroquery
# Weight by multiplying or dividing by WM length
fc_sc_weighting_df <- fc_sc_df[, c(1:9)]
fc_sc_weighting_df$SC_Count_x_Length <- fc_sc_weighting_df$SC_Count * fc_sc_weighting_df$SC_Length
fc_sc_weighting_df$SC_Count_x_Length <- fc_sc_weighting_df$SC_Count_x_Length/max(fc_sc_weighting_df$SC_Count_x_Length)
fc_sc_weighting_df$SC_Count_div_Length <- NA
for (i in 1:nrow(fc_sc_weighting_df)){
  progress(i, nrow(fc_sc_weighting_df))
  if (fc_sc_weighting_df$SC_Length[i] == 0){
    fc_sc_weighting_df$SC_Count_div_Length[i] <- 0
  } else {
    fc_sc_weighting_df$SC_Count_div_Length[i] <- (fc_sc_weighting_df$SC_Count[i] / fc_sc_weighting_df$SC_Length[i])
    fc_sc_weighting_df$SC_Count_div_Length[i] <- fc_sc_weighting_df$SC_Count_div_Length[i]/max(fc_sc_weighting_df$SC_Count_div_Length[i])
  }
}

sc_weighting_test_df <- data.frame("SC_type" = c(rep("SC_Count", 3),
                                                 rep("SC_Count_x_Length", 3),
                                                 rep("SC_Count_div_Length", 3)
                                                 ),
                                   "FC_type" = rep(c("FC_Neuroquery", "FC_Neurosynth", "FC_rsfMRI"), 3),
                                   "adjR2" = NA)

for (i in 1:nrow(sc_weighting_test_df)){
  sc_weighting_test_df$adjR2[i] <- summary(lm(fc_sc_weighting_df[,which(names(fc_sc_weighting_df) == sc_weighting_test_df$FC_type[i])] ~ fc_sc_weighting_df[,which(names(fc_sc_weighting_df) == sc_weighting_test_df$SC_type[i])]))$adj.r.squared
}

sc_weighting_test_df$SC_type_label <- sc_weighting_test_df$SC_type
sc_weighting_test_df$SC_type_label[sc_weighting_test_df$SC_type_label == "SC_Count"] <- "Count"
sc_weighting_test_df$SC_type_label[sc_weighting_test_df$SC_type_label == "SC_Count_x_Length"] <- "Count*Length"
sc_weighting_test_df$SC_type_label[sc_weighting_test_df$SC_type_label == "SC_Count_div_Length"] <- "Count/Length"

sc_weighting_test_df$FC_type_label <- sc_weighting_test_df$FC_type
sc_weighting_test_df$FC_type_label[sc_weighting_test_df$FC_type_label == "FC_Neuroquery"] <- "NeuroQuery"
sc_weighting_test_df$FC_type_label[sc_weighting_test_df$FC_type_label == "FC_Neurosynth"] <- "Neurosynth"
sc_weighting_test_df$FC_type_label[sc_weighting_test_df$FC_type_label == "FC_rsfMRI"] <- "rsfMRI"
sc_weighting_test_df$FC_type_label <- factor(sc_weighting_test_df$FC_type_label, levels = c("Neurosynth", "NeuroQuery", "rsfMRI"))

sc_weighting_test_bar <-
  ggplot(sc_weighting_test_df, 
       aes(x = FC_type_label, y = adjR2, fill = SC_type_label)) +
  geom_bar(position = "dodge", stat = "identity", color = "black") +
  xlab("FC Type") +
  ylab(bquote("SF"~R^2)) +
  labs(fill = "SC WM Count Weighting") +
  theme_classic() +
  theme(axis.text= element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5),
        legend.key.size = unit(1, 'cm'),
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=15), 
        legend.text = element_text(size=14))

ggsave("../figures/subplots/supp_sc_weighting_test_bar.png", 
       plot = sc_weighting_test_bar,
       width = 3000,
       height = 2200,
       units = "px")
```


## Supplementary 3

This figure was produced from `spectral_clustering_and_diffusion_mapping.ipynb`.


## Supplementary 4

See code chunks above.


## Supplementary 5

```{r}
# SF R squared vs. structural degree
sc_wmpathcount_matrix_binary <- sc_wmpathcount_matrix
sc_wmpathcount_matrix_binary[sc_wmpathcount_matrix_binary != 0] <- 1
sf_df$sc_degree <- rowSums(sc_wmpathcount_matrix_binary)

round(summary(lm(sf_df$rsq_neurosynth ~ sf_df$sc_degree))$adj.r.squared, 3)

sc_degree_line <- ggplot(sf_df, 
                         aes(x = sc_degree, y = rsq_neurosynth)) + 
                    geom_point(color = "#154360", size = 3, alpha = 0.7) + 
                    geom_smooth(method = lm, se = FALSE, color = "red") + 
                    theme_classic() +
                    ylab(bquote("SF"~R^2)) +
                    xlab("SC-Count degree") +
                    ggtitle(paste0("R<sup>2</sup> = ", 
                                   round(summary(lm(sf_df$rsq_neurosynth ~ sf_df$sc_degree))$adj.r.squared, 3),
                                   ", Spearman r = ",
                 round(cor.test(x = sf_df$sc_degree, y = sf_df$rsq_neurosynth, method = "spearman", exact = FALSE)$estimate, 2))) + 
                    theme(axis.text= element_text(size = 22),
                          axis.title = element_text(size = 22),
                          plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/supp_sc_degree_line.png", 
       plot = sc_degree_line,
       width = 2000,
       height = 2000,
       units = "px")


# SF R squared vs. functional degree (Neurosynth)
sf_df$fc_neurosynth_degree <- rowSums(fc_neurosynth_matrix)

fc_neurosynth_degree_line <- ggplot(sf_df, 
                                    aes(x = fc_neurosynth_degree, y = rsq_neurosynth)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.7) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  ylab(bquote("SF"~R^2)) +
  xlab("FC-Neurosynth degree") +
  ggtitle(paste0("R<sup>2</sup> = ", 
                                   round(summary(lm(sf_df$rsq_neurosynth ~ sf_df$fc_neurosynth_degree))$adj.r.squared, 3),
                                   ", Spearman r = ",
                 round(cor.test(x = sf_df$fc_neurosynth_degree, y = sf_df$rsq_neurosynth, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/supp_fc_neurosynth_degree_line.png", 
       plot = fc_neurosynth_degree_line,
       width = 2000,
       height = 2000,
       units = "px")

# SF R squared vs. functional degree (NeuroQuery)
sf_df$fc_neuroquery_degree <- rowSums(fc_neuroquery_matrix)

fc_neuroquery_degree_line <- ggplot(sf_df, 
                                    aes(x = fc_neuroquery_degree, y = rsq_neuroquery)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.7) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  ylab(bquote("SF"~R^2)) +
  xlab("FC-NeuroQuery degree") +
  ggtitle(paste0("R<sup>2</sup> = ", 
                                   round(summary(lm(sf_df$rsq_neuroquery ~ sf_df$fc_neuroquery_degree))$adj.r.squared, 3),
                                   ", Spearman r = ",
                 round(cor.test(x = sf_df$fc_neuroquery_degree, y = sf_df$rsq_neuroquery, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/supp_fc_neuroquery_degree_line.png", 
       plot = fc_neuroquery_degree_line,
       width = 2000,
       height = 2000,
       units = "px")


# SF R squared vs. functional degree (rsfMRI)
sf_df$fc_rsfmri_degree <- rowSums(fc_rsfmri_matrix)

fc_rsfmri_degree_line <- ggplot(sf_df, 
                                    aes(x = fc_rsfmri_degree, y = rsq_rsfmri)) + 
  geom_point(color = "#154360", size = 3, alpha = 0.7) + 
  geom_smooth(method = lm, se = FALSE, color = "red") + 
  theme_classic() +
  ylab(bquote("SF"~R^2)) +
  xlab("FC-rsfMRI degree") +
  ggtitle(paste0("R<sup>2</sup> = ", 
                                   round(summary(lm(sf_df$rsq_rsfmri ~ sf_df$fc_rsfmri_degree))$adj.r.squared, 3),
                                   ", Spearman r = ",
                 round(cor.test(x = sf_df$fc_rsfmri_degree, y = sf_df$rsq_rsfmri, method = "spearman", exact = FALSE)$estimate, 2))) + 
  theme(axis.text= element_text(size = 22),
        axis.title = element_text(size = 22),
        plot.title = element_markdown(size = 22, hjust = 0.5))

ggsave("../figures/subplots/supp_fc_rsfmri_degree_line.png", 
       plot = fc_rsfmri_degree_line,
       width = 2000,
       height = 2000,
       units = "px")
```


## Supplementary 6

See code chunks above.


## Supplementary 7

```{r}
# Supplementary
# Neurosynth - SC_Coswei
# Determine which parcels are active (i.e,. nonzero) for each functional term
active_parcels_by_term <- list()
for (i in 1:ncol(neurosynth_functional_activation_df)){
  active_parcels_by_term[[i]] <- neurosynth_functional_activation_df[,i]
  active_parcels_by_term[[i]][active_parcels_by_term[[i]] != 0] <- 1
}
# For each functional term, create a dataframe which classifies
# the activity/inactivity of the two parcels making up each pairwise connection 
term_i_analysis <- list()
for (i in 1:ncol(neurosynth_functional_activation_df)){
  svMisc::progress(i, ncol(neurosynth_functional_activation_df))
  term_i_analysis[[i]] <- fc_sc_df[,c(1:2, 6, 8, 12, 13)]
  term_i_analysis[[i]]$Parcel_A_type <- NA
  term_i_analysis[[i]]$Parcel_A_type[term_i_analysis[[i]]$Parcel_A_ID %in% which(neurosynth_functional_activation_df[,i] != 0)] <- "active"
  term_i_analysis[[i]]$Parcel_A_type[term_i_analysis[[i]]$Parcel_A_ID %in% which(neurosynth_functional_activation_df[,i] == 0)] <- "inactive"
  term_i_analysis[[i]]$Parcel_B_type <- NA
  term_i_analysis[[i]]$Parcel_B_type[term_i_analysis[[i]]$Parcel_B_ID %in% which(neurosynth_functional_activation_df[,i] != 0)] <- "active"
  term_i_analysis[[i]]$Parcel_B_type[term_i_analysis[[i]]$Parcel_B_ID %in% which(neurosynth_functional_activation_df[,i] == 0)] <- "inactive"
  term_i_analysis[[i]] <- term_i_analysis[[i]][!term_i_analysis[[i]]$Parcel_A_type == "inactive", ]
  row.names(term_i_analysis[[i]]) <- NULL
}

# Count the number of active-active parcel connections for each term
num_active_active_connections <- c()
for (i in 1:length(term_i_analysis)){
  num_active_active_connections[i] <- nrow(term_i_analysis[[i]][term_i_analysis[[i]]$Parcel_A_type == "active" & term_i_analysis[[i]]$Parcel_B_type == "active", ])
}

# Remove functional terms with less than 50 active-active parcel connections
term_i_analysis_clean <- term_i_analysis[-which(num_active_active_connections < 50)]
#term_i_analysis_clean <- term_i_analysis

# Structure-function by term analysis
# Compute proportion connected, i.e., 
# the proportion of all possible connections between the parcels activated for 
# a particular functional term that have a non-zero number of white matter (WM) streamlines. 
# Moreover, and more importantly, run a Wilcoxon test to evaluate if the # of WM tracts
# between active-active parcels is different from those between active-inactive parcels
# Store the Wilcoxon effect size, p value, and fold change
wilcox_effect_size <- c()
wilcox_p_value <- c()
fold_change <- c()
log_fold_change <- c()
mean_eucl_dist_active_active <- c()
mean_eucl_dist_active_inactive <- c()
for (i in 1:length(term_i_analysis_clean)){
  svMisc::progress(i, length(term_i_analysis_clean))
  wilcox_effect_size[i] <- as.numeric(wilcox.test(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "active"], 
            term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])$statistic/sqrt(nrow(term_i_analysis_clean[[i]])))
  wilcox_p_value[i] <- wilcox.test(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[1]]$Parcel_B_type == "active"], 
            term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])$p.value
  fold_change[i] <- mean(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "active"])/mean(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])
  log_fold_change[i] <- log10(mean(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "active"])) - log10(mean(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"]))
  mean_eucl_dist_active_active[i] <- mean(term_i_analysis_clean[[i]]$SC_Eucl_dist[(term_i_analysis_clean[[i]]$Parcel_B_type == "active")])
  mean_eucl_dist_active_inactive[i] <- mean(term_i_analysis_clean[[i]]$SC_Eucl_dist[(term_i_analysis_clean[[i]]$Parcel_B_type == "inactive")])
}

# Make dataframe for SF correspondence by term results above
# Only select terms that have a minimum of 50 active-active parcel connections
# This reduces functional terms from 334 to 313
sf_by_term_df <- data.frame("term" = colnames(neurosynth_functional_activation_df)[-which(num_active_active_connections < 50)],
                            "wilcox_effect_size" = wilcox_effect_size,
                            "wilcox_p_value" = wilcox_p_value,
                            "wilcox_adj_p_value" = length(prop_connected) * wilcox_p_value,
                            "fold_change" = fold_change,
                            "log_fold_change" = log_fold_change,
                            "mean_eucl_dist_active_active" = mean_eucl_dist_active_active,
                            "mean_eucl_dist_active_inactive" = mean_eucl_dist_active_inactive)

alpha_crit <- 0.05
fc_upper_threshold <- as.numeric(quantile(sf_by_term_df$fold_change[sf_by_term_df$wilcox_adj_p_value < alpha_crit], 0.2))
fc_lower_threshold <- fc_upper_threshold
sf_by_term_df$de_label <- NA
#sf_by_term_df$de_label <- sf_by_term_df$term
sf_by_term_df$de_label[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)] <- sf_by_term_df$term[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)]
sf_by_term_df$de_label[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)] <- sf_by_term_df$term[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)]

sf_by_term_df$de_color <- "#BDBDBD"
sf_by_term_df$de_color[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)] <- "#F8766D"
sf_by_term_df$de_color[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)] <- "#00A9FF"

# Plot fold change and p value for the Wilcoxon test
# This serves as a right-sided volcano-type plot to isolate terms
# with higher (red) and lower (blue) structure-function strength 

# Supplementary plot showing all term labels
sf_by_term_fold_p_all_plot <-
  ggplot(
  data = sf_by_term_df, 
  aes(x = log2(fold_change), 
      y = -log10(wilcox_adj_p_value),
      label = de_label)) +
        geom_point(col = sf_by_term_df$de_color, alpha = 0.5, size = 3) + 
        theme_classic() +
        geom_text_repel(col = sf_by_term_df$de_color, size = 3.5, max.overlaps = getOption("ggrepel.max.overlaps", default = 40)) +
        geom_vline(xintercept = c(log2(fc_upper_threshold)), col = "#424242", linetype = "dashed") +
        geom_vline(xintercept = c(log2(fc_lower_threshold)), col = "#424242", linetype = "dashed") +
        geom_hline(yintercept = -log10(alpha_crit), col = "#424242", linetype = "dashed") +
  xlab("log2(Fold Change)") +
  ylab("-log10(p-Value)") +
  #xlim(c(0.1, 1.48)) +
  annotate("text", x = 2.6, y = 2.5, label = paste0("p = ", alpha_crit), color = "#424242") +
  theme(axis.text = element_text(size = 16),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16))

ggsave("../figures/subplots/supp_sf_by_term_fold_p_all_neurosynth_cos_plot.png", 
       plot = sf_by_term_fold_p_all_plot,
       width = 2500,
       height = 2500,
       units = "px")

# Load in tSNE embedding of Neurosynth functional terms
sf_by_term_tsne_df <- read.csv("../data/misc/tsne_neurosynth_wmcount_threshup20q_perp50.csv")
#wilcox.test(sf_by_term_tsne_df$tSNE1[sf_by_term_tsne_df$term %in% sf_by_term_df$term[sf_by_term_df$de_color == "#F8766D"]],
#            sf_by_term_tsne_df$tSNE1[sf_by_term_tsne_df$term %in% sf_by_term_df$term[sf_by_term_df$de_color == "#00A9FF"]])

sf_by_term_tsne_df$de_color_cos <- "#BDBDBD"
sf_by_term_tsne_df$de_color_cos[sf_by_term_tsne_df$term %in% sf_by_term_df$term[sf_by_term_df$de_color == "#F8766D"]] <- "#F8766D"
sf_by_term_tsne_df$de_color_cos[sf_by_term_tsne_df$term %in% sf_by_term_df$term[sf_by_term_df$de_color == "#00A9FF"]] <- "#00A9FF"

# Plot boxplot of tSNE1 embedding across High SF and Low SF terms
sf_by_term_grouped_df <- sf_by_term_tsne_df[sf_by_term_tsne_df$de_color_cos != "#BDBDBD",]
sf_by_term_grouped_df$sf_strength <- "High SF"
sf_by_term_grouped_df$sf_strength[sf_by_term_grouped_df$de_color_cos == "#00A9FF"] <- "Low SF"
sf_by_term_grouped_df$sf_strength_binary <- sf_by_term_grouped_df$sf_strength
sf_by_term_grouped_df$sf_strength_binary[sf_by_term_grouped_df$sf_strength_binary == "High SF"] <- 1
sf_by_term_grouped_df$sf_strength_binary[sf_by_term_grouped_df$sf_strength_binary == "Low SF"] <- 0
sf_by_term_grouped_df$sf_strength_binary <- as.numeric(sf_by_term_grouped_df$sf_strength_binary)

wilcox_p_value_tsne1 <- sprintf("%.2e", wilcox.test(sf_by_term_grouped_df$tSNE1[sf_by_term_grouped_df$sf_strength == "High SF"], sf_by_term_grouped_df$tSNE1[sf_by_term_grouped_df$sf_strength == "Low SF"])$p.value)

# Plot tSNE1
sf_by_term_cos_tsne1_box <-
  ggplot(sf_by_term_grouped_df, 
       aes(x = sf_strength, y = tSNE1, fill = sf_strength)) + 
  geom_boxplot(notch = T) +
  theme_classic() +
  xlab("") +
  ylab("tSNE1") +
  scale_fill_manual(values = c("#F8766D", "#00A9FF")) +
  ggtitle(paste0("p = ", wilcox_p_value_tsne1)) + 
  theme(axis.text = element_text(size = 22),
        axis.title.x = element_text(colour = "black", size = 22),
        axis.title.y = element_text(colour = "black", size = 22),
        plot.title = element_text(hjust = 0.5, size = 22)) +
  guides(fill="none")

ggsave("../figures/subplots/supp_sf_by_term_cos_tsne1_box.png", 
       plot = sf_by_term_cos_tsne1_box,
       width = 1250,
       height = 2500,
       units = "px")
```

```{r}
# Supplementary
# Neuroquery - SC_Count
# Determine which parcels are active (i.e,. nonzero) for each functional term
active_parcels_by_term <- list()
for (i in 1:ncol(neuroquery_functional_activation_df)){
  active_parcels_by_term[[i]] <- neuroquery_functional_activation_df[,i]
  active_parcels_by_term[[i]][active_parcels_by_term[[i]] != 0] <- 1
}
# For each functional term, create a dataframe which classifies
# the activity/inactivity of the two parcels making up each pairwise connection 
term_i_analysis <- list()
for (i in 1:ncol(neuroquery_functional_activation_df)){
  svMisc::progress(i, ncol(neuroquery_functional_activation_df))
  term_i_analysis[[i]] <- fc_sc_df[,c(1:2, 6, 8, 12, 13)]
  term_i_analysis[[i]]$Parcel_A_type <- NA
  term_i_analysis[[i]]$Parcel_A_type[term_i_analysis[[i]]$Parcel_A_ID %in% which(neuroquery_functional_activation_df[,i] != 0)] <- "active"
  term_i_analysis[[i]]$Parcel_A_type[term_i_analysis[[i]]$Parcel_A_ID %in% which(neuroquery_functional_activation_df[,i] == 0)] <- "inactive"
  term_i_analysis[[i]]$Parcel_B_type <- NA
  term_i_analysis[[i]]$Parcel_B_type[term_i_analysis[[i]]$Parcel_B_ID %in% which(neuroquery_functional_activation_df[,i] != 0)] <- "active"
  term_i_analysis[[i]]$Parcel_B_type[term_i_analysis[[i]]$Parcel_B_ID %in% which(neuroquery_functional_activation_df[,i] == 0)] <- "inactive"
  term_i_analysis[[i]] <- term_i_analysis[[i]][!term_i_analysis[[i]]$Parcel_A_type == "inactive", ]
  row.names(term_i_analysis[[i]]) <- NULL
}

# Count the number of active-active parcel connections for each term
num_active_active_connections <- c()
for (i in 1:length(term_i_analysis)){
  num_active_active_connections[i] <- nrow(term_i_analysis[[i]][term_i_analysis[[i]]$Parcel_A_type == "active" & term_i_analysis[[i]]$Parcel_B_type == "active", ])
}

# Remove functional terms with less than 50 active-active parcel connections
#term_i_analysis_clean <- term_i_analysis[-which(num_active_active_connections < 50)]
term_i_analysis_clean <- term_i_analysis

# Structure-function by term analysis
# Compute proportion connected, i.e., 
# the proportion of all possible connections between the parcels activated for 
# a particular functional term that have a non-zero number of white matter (WM) streamlines. 
# Moreover, and more importantly, run a Wilcoxon test to evaluate if the # of WM tracts
# between active-active parcels is different from those between active-inactive parcels
# Store the Wilcoxon effect size, p value, and fold change
wilcox_effect_size <- c()
wilcox_p_value <- c()
fold_change <- c()
log_fold_change <- c()
mean_eucl_dist_active_active <- c()
mean_eucl_dist_active_inactive <- c()
for (i in 1:length(term_i_analysis_clean)){
  svMisc::progress(i, length(term_i_analysis_clean))
  wilcox_effect_size[i] <- as.numeric(wilcox.test(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "active"], 
            term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])$statistic/sqrt(nrow(term_i_analysis_clean[[i]])))
  wilcox_p_value[i] <- wilcox.test(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[1]]$Parcel_B_type == "active"], 
            term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])$p.value
  fold_change[i] <- mean(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "active"])/mean(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])
  log_fold_change[i] <- log10(mean(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "active"])) - log10(mean(term_i_analysis_clean[[i]]$SC_Count[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"]))
  mean_eucl_dist_active_active[i] <- mean(term_i_analysis_clean[[i]]$SC_Eucl_dist[(term_i_analysis_clean[[i]]$Parcel_B_type == "active")])
  mean_eucl_dist_active_inactive[i] <- mean(term_i_analysis_clean[[i]]$SC_Eucl_dist[(term_i_analysis_clean[[i]]$Parcel_B_type == "inactive")])
}

# Make dataframe for SF correspondence by term results above
sf_by_term_df <- data.frame("term" = colnames(neuroquery_functional_activation_df),
                            "wilcox_effect_size" = wilcox_effect_size,
                            "wilcox_p_value" = wilcox_p_value,
                            "wilcox_adj_p_value" = length(prop_connected) * wilcox_p_value,
                            "fold_change" = fold_change,
                            "log_fold_change" = log_fold_change,
                            "mean_eucl_dist_active_active" = mean_eucl_dist_active_active,
                            "mean_eucl_dist_active_inactive" = mean_eucl_dist_active_inactive)
sf_by_term_df[sf_by_term_df$wilcox_adj_p_value < alpha_crit,]
alpha_crit <- 0.001
fc_upper_threshold <- as.numeric(quantile(sf_by_term_df$fold_change[sf_by_term_df$wilcox_adj_p_value < alpha_crit], 0.8))
fc_lower_threshold <- fc_upper_threshold
sf_by_term_df$de_label <- NA
#sf_by_term_df$de_label <- sf_by_term_df$term
sf_by_term_df$de_label[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)] <- sf_by_term_df$term[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)]
sf_by_term_df$de_label[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)] <- sf_by_term_df$term[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)]

sf_by_term_df$de_color <- "#BDBDBD"
sf_by_term_df$de_color[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)] <- "#F8766D"
sf_by_term_df$de_color[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)] <- "#00A9FF"

# Plot fold change and p value for the Wilcoxon test
# This serves as a right-sided volcano-type plot to isolate terms
# with higher (red) and lower (blue) structure-function strength 

# Supplementary plot showing all term labels
sf_by_term_fold_p_all_plot <-
  ggplot(
  data = sf_by_term_df, 
  aes(x = log2(fold_change), 
      y = -log10(wilcox_adj_p_value),
      label = de_label)) +
        geom_point(col = sf_by_term_df$de_color, alpha = 0.5, size = 3) + 
        theme_classic() +
        geom_text_repel(col = sf_by_term_df$de_color, size = 3.5, max.overlaps = getOption("ggrepel.max.overlaps", default = 50)) +
        geom_vline(xintercept = c(log2(fc_upper_threshold)), col = "#424242", linetype = "dashed") +
        geom_vline(xintercept = c(log2(fc_lower_threshold)), col = "#424242", linetype = "dashed") +
        geom_hline(yintercept = -log10(alpha_crit), col = "#424242", linetype = "dashed") +
  xlab("log2(Fold Change)") +
  ylab("-log10(p-Value)") +
  #ylim(c(-6, 290)) +
  annotate("text", x = 3.5, y = 7.5, label = paste0("p = ", alpha_crit), color = "#424242") +
  theme(axis.text = element_text(size = 16),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16))

ggsave("../figures/subplots/supp_sf_by_term_fold_p_all_neuroquery_count_plot.png", 
       plot = sf_by_term_fold_p_all_plot,
       width = 2500,
       height = 2500,
       units = "px")
```


```{r}
# Supplementary
# Neuroquery - SC_Coswei
# Determine which parcels are active (i.e,. nonzero) for each functional term
active_parcels_by_term <- list()
for (i in 1:ncol(neuroquery_functional_activation_df)){
  active_parcels_by_term[[i]] <- neuroquery_functional_activation_df[,i]
  active_parcels_by_term[[i]][active_parcels_by_term[[i]] != 0] <- 1
}
# For each functional term, create a dataframe which classifies
# the activity/inactivity of the two parcels making up each pairwise connection 
term_i_analysis <- list()
for (i in 1:ncol(neuroquery_functional_activation_df)){
  svMisc::progress(i, ncol(neuroquery_functional_activation_df))
  term_i_analysis[[i]] <- fc_sc_df[,c(1:2, 6, 8, 12, 13)]
  term_i_analysis[[i]]$Parcel_A_type <- NA
  term_i_analysis[[i]]$Parcel_A_type[term_i_analysis[[i]]$Parcel_A_ID %in% which(neuroquery_functional_activation_df[,i] != 0)] <- "active"
  term_i_analysis[[i]]$Parcel_A_type[term_i_analysis[[i]]$Parcel_A_ID %in% which(neuroquery_functional_activation_df[,i] == 0)] <- "inactive"
  term_i_analysis[[i]]$Parcel_B_type <- NA
  term_i_analysis[[i]]$Parcel_B_type[term_i_analysis[[i]]$Parcel_B_ID %in% which(neuroquery_functional_activation_df[,i] != 0)] <- "active"
  term_i_analysis[[i]]$Parcel_B_type[term_i_analysis[[i]]$Parcel_B_ID %in% which(neuroquery_functional_activation_df[,i] == 0)] <- "inactive"
  term_i_analysis[[i]] <- term_i_analysis[[i]][!term_i_analysis[[i]]$Parcel_A_type == "inactive", ]
  row.names(term_i_analysis[[i]]) <- NULL
}

# Count the number of active-active parcel connections for each term
num_active_active_connections <- c()
for (i in 1:length(term_i_analysis)){
  num_active_active_connections[i] <- nrow(term_i_analysis[[i]][term_i_analysis[[i]]$Parcel_A_type == "active" & term_i_analysis[[i]]$Parcel_B_type == "active", ])
}

# Remove functional terms with less than 50 active-active parcel connections
#term_i_analysis_clean <- term_i_analysis[-which(num_active_active_connections < 50)]
term_i_analysis_clean <- term_i_analysis

# Structure-function by term analysis
# Compute proportion connected, i.e., 
# the proportion of all possible connections between the parcels activated for 
# a particular functional term that have a non-zero number of white matter (WM) streamlines. 
# Moreover, and more importantly, run a Wilcoxon test to evaluate if the # of WM tracts
# between active-active parcels is different from those between active-inactive parcels
# Store the Wilcoxon effect size, p value, and fold change
wilcox_effect_size <- c()
wilcox_p_value <- c()
fold_change <- c()
log_fold_change <- c()
mean_eucl_dist_active_active <- c()
mean_eucl_dist_active_inactive <- c()
for (i in 1:length(term_i_analysis_clean)){
  svMisc::progress(i, length(term_i_analysis_clean))
  wilcox_effect_size[i] <- as.numeric(wilcox.test(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "active"], 
            term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])$statistic/sqrt(nrow(term_i_analysis_clean[[i]])))
  wilcox_p_value[i] <- wilcox.test(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[1]]$Parcel_B_type == "active"], 
            term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])$p.value
  fold_change[i] <- mean(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "active"])/mean(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"])
  log_fold_change[i] <- log10(mean(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "active"])) - log10(mean(term_i_analysis_clean[[i]]$SC_Coswei[term_i_analysis_clean[[i]]$Parcel_B_type == "inactive"]))
  mean_eucl_dist_active_active[i] <- mean(term_i_analysis_clean[[i]]$SC_Eucl_dist[(term_i_analysis_clean[[i]]$Parcel_B_type == "active")])
  mean_eucl_dist_active_inactive[i] <- mean(term_i_analysis_clean[[i]]$SC_Eucl_dist[(term_i_analysis_clean[[i]]$Parcel_B_type == "inactive")])
}

# Make dataframe for SF correspondence by term results above
sf_by_term_df <- data.frame("term" = colnames(neuroquery_functional_activation_df),
                            "wilcox_effect_size" = wilcox_effect_size,
                            "wilcox_p_value" = wilcox_p_value,
                            "wilcox_adj_p_value" = length(prop_connected) * wilcox_p_value,
                            "fold_change" = fold_change,
                            "log_fold_change" = log_fold_change,
                            "mean_eucl_dist_active_active" = mean_eucl_dist_active_active,
                            "mean_eucl_dist_active_inactive" = mean_eucl_dist_active_inactive)
sf_by_term_df[sf_by_term_df$wilcox_adj_p_value < alpha_crit,]
alpha_crit <- 0.001
fc_upper_threshold <- as.numeric(quantile(sf_by_term_df$fold_change[sf_by_term_df$wilcox_adj_p_value < alpha_crit], 0.8))
fc_lower_threshold <- fc_upper_threshold
sf_by_term_df$de_label <- NA
#sf_by_term_df$de_label <- sf_by_term_df$term
sf_by_term_df$de_label[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)] <- sf_by_term_df$term[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)]
sf_by_term_df$de_label[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)] <- sf_by_term_df$term[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)]

sf_by_term_df$de_color <- "#BDBDBD"
sf_by_term_df$de_color[(sf_by_term_df$wilcox_adj_p_value <= alpha_crit) & (sf_by_term_df$fold_change >= fc_upper_threshold)] <- "#F8766D"
sf_by_term_df$de_color[(sf_by_term_df$wilcox_adj_p_value > alpha_crit) & (sf_by_term_df$fold_change < fc_lower_threshold)] <- "#00A9FF"

# Remove terms that have p values of perfect 0; indicated by having no inactive connections; omit for this plot for aesthetic.
sf_by_term_df <- sf_by_term_df[-which(sf_by_term_df$term == "abuse"), ]
sf_by_term_df <- sf_by_term_df[-which(sf_by_term_df$term == "psychotic"), ]

# Plot fold change and p value for the Wilcoxon test
# This serves as a right-sided volcano-type plot to isolate terms
# with higher (red) and lower (blue) structure-function strength 

# Supplementary plot showing all term labels
sf_by_term_fold_p_all_plot <-
  ggplot(
  data = sf_by_term_df, 
  aes(x = log2(fold_change), 
      y = -log10(wilcox_adj_p_value),
      label = de_label)) +
        geom_point(col = sf_by_term_df$de_color, alpha = 0.5, size = 3) + 
        theme_classic() +
        geom_text_repel(col = sf_by_term_df$de_color, size = 3.5, max.overlaps = getOption("ggrepel.max.overlaps", default = 50)) +
        geom_vline(xintercept = c(log2(fc_upper_threshold)), col = "#424242", linetype = "dashed") +
        geom_vline(xintercept = c(log2(fc_lower_threshold)), col = "#424242", linetype = "dashed") +
        geom_hline(yintercept = -log10(alpha_crit), col = "#424242", linetype = "dashed") +
  xlab("log2(Fold Change)") +
  ylab("-log10(p-Value)") +
  #ylim(c(-6, 290)) +
  annotate("text", x = 2.5, y = 7.5, label = paste0("p = ", alpha_crit), color = "#424242") +
  theme(axis.text = element_text(size = 16),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16))

ggsave("../figures/subplots/supp_sf_by_term_fold_p_all_neuroquery_cos_plot.png", 
       plot = sf_by_term_fold_p_all_plot,
       width = 2500,
       height = 2500,
       units = "px")
```


## Supplementary 8

See code chunks above.


## Supplementary 9

## Supplementary 9A

```{r}
# Spin tests for macroscale functional gradients
# FC diffusion 1

# null model spin test
coef_list <- rep(NA, 10000)
for (i in 1:10000){ # number of trials
  random_ordered_vector <- sample(sf_df$fc_diff1)
  coef_list[i] <- cor.test(y = sf_df$rsq_neurosynth, x = random_ordered_vector, method = "spearman")$estimate
}

measured_cor_value <- cor.test(y = sf_df$rsq_neurosynth, x = sf_df$fc_diff1, method = "spearman")$estimate

# P value from spin test
spin_test_p_value <- length(which(coef_list > measured_cor_value))/length(coef_list)
# p value of 0 here suggests less than 1/number of runs

coef_list_df <- data.frame("coef" = coef_list)

fc_diff_spin <-
  ggplot(coef_list_df, aes(x=coef)) + 
  geom_histogram(color="black", 
                 fill="#F8766D",
                 bins = 50,
                 alpha = 0.7) +
  geom_vline(aes(xintercept = measured_cor_value),
             color = "#00BFC4", linetype = "dashed", linewidth = 1.5) +
  theme_classic() +
  xlab("Spearman r") +
  ylab("Count (10,000 runs)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5)) +
  ggtitle(paste0("FC diffusion 1: Spearman r = ", round(measured_cor_value, 2), ", p < 1e-4"))


ggsave("../figures/subplots/supp_fc_diff_spin.png", 
       plot = fc_diff_spin,
       width = 3000,
       height = 2000,
       units = "px")
```


## Supplementary 9B

```{r}
# Spin tests for macroscale functional gradients
# FA PC1

# null model spin test
coef_list <- rep(NA, 10000)
for (i in 1:10000){ # number of trials
  random_ordered_vector <- sample(sf_df$fc_diff1)
  coef_list[i] <- cor.test(y = sf_df$rsq_neurosynth, x = random_ordered_vector, method = "spearman")$estimate
}

measured_cor_value <- cor.test(y = sf_df$rsq_neurosynth, x = sf_df$fa_pc1, method = "spearman")$estimate

# P value from spin test
spin_test_p_value <- length(which(coef_list > measured_cor_value))/length(coef_list)
# p value of 0 here suggests less than 1/number of runs

coef_list_df <- data.frame("coef" = coef_list)

fa_pc1_spin <-
  ggplot(coef_list_df, aes(x=coef)) + 
  geom_histogram(color="black", 
                 fill="#F8766D",
                 bins = 50,
                 alpha = 0.7) +
  geom_vline(aes(xintercept = measured_cor_value),
             color = "#00BFC4", linetype = "dashed", linewidth = 1.5) +
  theme_classic() +
  xlab("Spearman r") +
  ylab("Count (10,000 runs)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5)) +
  ggtitle(paste0("FA PC1: Spearman r = ", round(measured_cor_value, 2), ", p < 1e-4"))


ggsave("../figures/subplots/supp_fa_pc1_spin.png", 
       plot = fa_pc1_spin,
       width = 3000,
       height = 2000,
       units = "px")
```


## Supplementary 9C

```{r}
# Spin tests for macroscale functional gradients
# Functional diversity

# null model spin test
coef_list <- rep(NA, 10000)
for (i in 1:10000){ # number of trials
  random_ordered_vector <- sample(sf_df$fc_diff1)
  coef_list[i] <- cor.test(y = sf_df$rsq_neurosynth, x = random_ordered_vector, method = "spearman")$estimate
}

measured_cor_value <- cor.test(y = sf_df$rsq_neurosynth, x = sf_df$func_div, method = "spearman")$estimate

# P value from spin test
spin_test_p_value <- length(which(coef_list < measured_cor_value))/length(coef_list)
# p value of 0 here suggests less than 1/number of runs

coef_list_df <- data.frame("coef" = coef_list)

func_div_spin <-
  ggplot(coef_list_df, aes(x=coef)) + 
  geom_histogram(color="black", 
                 fill="#F8766D",
                 bins = 50,
                 alpha = 0.7) +
  geom_vline(aes(xintercept = measured_cor_value),
             color = "#00BFC4", linetype = "dashed", linewidth = 1.5) +
  theme_classic() +
  xlab("Spearman r") +
  ylab("Count (10,000 runs)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5)) +
  ggtitle(paste0("Functional diversity: Spearman r = ", round(measured_cor_value, 2), ", p < 1e-4"))


ggsave("../figures/subplots/supp_func_div_spin.png", 
       plot = func_div_spin,
       width = 3000,
       height = 2000,
       units = "px")
```


## Supplementary 9D

```{r}
# Spin tests for macroscale functional gradients
# Concreteness (Sensory-motor function)

# null model spin test
coef_list <- rep(NA, 10000)
for (i in 1:10000){ # number of trials
  random_ordered_vector <- sample(sf_df$fc_diff1)
  coef_list[i] <- cor.test(y = sf_df$rsq_neurosynth, x = random_ordered_vector, method = "spearman")$estimate
}

measured_cor_value <- cor.test(y = sf_df$rsq_neurosynth, x = sf_df$concreteness, method = "spearman")$estimate

# P value from spin test
spin_test_p_value <- length(which(coef_list > measured_cor_value))/length(coef_list)
# p value of 0 here suggests less than 1/number of runs

coef_list_df <- data.frame("coef" = coef_list)

concreteness_spin <-
  ggplot(coef_list_df, aes(x=coef)) + 
  geom_histogram(color="black", 
                 fill="#F8766D",
                 bins = 50,
                 alpha = 0.7) +
  geom_vline(aes(xintercept = measured_cor_value),
             color = "#00BFC4", linetype = "dashed", linewidth = 1.5) +
  theme_classic() +
  xlab("Spearman r") +
  ylab("Count (10,000 runs)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5)) +
  ggtitle(paste0("Sensory-motor function: Spearman r = ", round(measured_cor_value, 2), ", p < 1e-4"))


ggsave("../figures/subplots/supp_concreteness_spin.png", 
       plot = concreteness_spin,
       width = 3000,
       height = 2000,
       units = "px")
```


## Supplementary 9E

```{r}
# Spin tests for macroscale functional gradients
# Perceptual function

# null model spin test
coef_list <- rep(NA, 10000)
for (i in 1:10000){ # number of trials
  random_ordered_vector <- sample(sf_df$fc_diff1)
  coef_list[i] <- cor.test(y = sf_df$rsq_neurosynth, x = random_ordered_vector, method = "spearman")$estimate
}

measured_cor_value <- cor.test(y = sf_df$rsq_neurosynth, x = sf_df$percept, method = "spearman")$estimate

# P value from spin test
spin_test_p_value <- length(which(coef_list > measured_cor_value))/length(coef_list)
# p value of 0 here suggests less than 1/number of runs

coef_list_df <- data.frame("coef" = coef_list)

percept_spin <-
  ggplot(coef_list_df, aes(x=coef)) + 
  geom_histogram(color="black", 
                 fill="#F8766D",
                 bins = 50,
                 alpha = 0.7) +
  geom_vline(aes(xintercept = measured_cor_value),
             color = "#00BFC4", linetype = "dashed", linewidth = 1.5) +
  theme_classic() +
  xlab("Spearman r") +
  ylab("Count (10,000 runs)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5)) +
  ggtitle(paste0("Perceptual function: Spearman r = ", round(measured_cor_value, 2), ", p < 1e-4"))


ggsave("../figures/subplots/supp_percept_spin.png", 
       plot = percept_spin,
       width = 3000,
       height = 2000,
       units = "px")
```


## Supplementary 9F

```{r}
# Spin tests for macroscale functional gradients
# Cognitive function

# null model spin test
coef_list <- rep(NA, 10000)
for (i in 1:10000){ # number of trials
  random_ordered_vector <- sample(sf_df$fc_diff1)
  coef_list[i] <- cor.test(y = sf_df$rsq_neurosynth, x = random_ordered_vector, method = "spearman")$estimate
}

measured_cor_value <- cor.test(y = sf_df$rsq_neurosynth, x = sf_df$cogproc, method = "spearman")$estimate

# P value from spin test
spin_test_p_value <- length(which(coef_list < measured_cor_value))/length(coef_list)
# p value of 0 here suggests less than 1/number of runs

coef_list_df <- data.frame("coef" = coef_list)

cogproc_spin <-
  ggplot(coef_list_df, aes(x=coef)) + 
  geom_histogram(color="black", 
                 fill="#F8766D",
                 bins = 50,
                 alpha = 0.7) +
  geom_vline(aes(xintercept = measured_cor_value),
             color = "#00BFC4", linetype = "dashed", linewidth = 1.5) +
  theme_classic() +
  xlab("Spearman r") +
  ylab("Count (10,000 runs)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5)) +
  ggtitle(paste0("Cognitive function: Spearman r = ", round(measured_cor_value, 2), ", p < 1e-4"))


ggsave("../figures/subplots/supp_cogproc_spin.png", 
       plot = cogproc_spin,
       width = 3000,
       height = 2000,
       units = "px")
```


## Supplementary 9G

```{r}
# Spin tests for macroscale functional gradients
# Biological function

# null model spin test
coef_list <- rep(NA, 10000)
for (i in 1:10000){ # number of trials
  random_ordered_vector <- sample(sf_df$fc_diff1)
  coef_list[i] <- cor.test(y = sf_df$rsq_neurosynth, x = random_ordered_vector, method = "spearman")$estimate
}

measured_cor_value <- cor.test(y = sf_df$rsq_neurosynth, x = sf_df$bio, method = "spearman")$estimate

# P value from spin test
spin_test_p_value <- length(which(coef_list > measured_cor_value))/length(coef_list)
# p value of 0 here suggests less than 1/number of runs

coef_list_df <- data.frame("coef" = coef_list)

bio_spin <-
  ggplot(coef_list_df, aes(x=coef)) + 
  geom_histogram(color="black", 
                 fill="#F8766D",
                 bins = 50,
                 alpha = 0.7) +
  geom_vline(aes(xintercept = measured_cor_value),
             color = "#00BFC4", linetype = "dashed", linewidth = 1.5) +
  theme_classic() +
  xlab("Spearman r") +
  ylab("Count (10,000 runs)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        plot.title = element_text(size = 20, hjust = 0.5)) +
  ggtitle(paste0("Biological function: Spearman r = ", round(measured_cor_value, 2), ", p < 1e-4"))


ggsave("../figures/subplots/supp_bio_spin.png", 
       plot = bio_spin,
       width = 3000,
       height = 2000,
       units = "px")
```


# Supplementary calculations

```{r}
cor.test(y = sf_df_690$mean_x, x = sf_df_690$cort_thick, method = "spearman") # sagittal
cor.test(y = sf_df_690$mean_y, x = sf_df_690$cort_thick, method = "spearman") # coronal
sprintf("%.2e", cor.test(x = sf_df_690$cort_thick, y = sf_df_690$mean_y, method = "spearman", exact = FALSE)$p.value)
round(summary(lm(mean_y ~ cort_thick, data = sf_df_690))$r.squared, 2)
cor.test(y = sf_df_690$mean_z, x = sf_df_690$cort_thick, method = "spearman") # axial
sprintf("%.2e", cor.test(x = sf_df_690$cort_thick, y = sf_df_690$mean_z, method = "spearman", exact = FALSE)$p.value)
round(summary(lm(mean_z ~ cort_thick, data = sf_df_690))$r.squared, 2)

sf_df_690$sc_degree <- sf_df$sc_degree[c(1:345, 349:693)]
round(summary(lm(cort_thick ~ sc_degree, data = sf_df_690))$r.squared, 2)
round(cor.test(x = sf_df_690$rsq_neurosynth, y = sf_df_690$cort_thick, method = "spearman", exact = FALSE)$estimate, 2)

round(summary(lm(FC_Neurosynth ~ FC_rsfMRI, data = fc_sc_df))$r.squared, 2)
round(summary(lm(FC_Neuroquery ~ FC_rsfMRI, data = fc_sc_df))$r.squared, 2)
round(summary(lm(FC_Neurosynth ~ FC_Neuroquery, data = fc_sc_df))$r.squared, 2)

cortthick_demo_df <- read.csv("../data/misc/cortthick_demographics.csv")
min(cortthick_demo_df$age)

rsfmri_control_demographics_df <- read.csv("../data/misc/rsfmri_control_demographics.csv")
table(rsfmri_control_demographics_df$sex)
mean(rsfmri_control_demographics_df$age.at.time.of.study)
min(rsfmri_control_demographics_df$age.at.time.of.study)
max(rsfmri_control_demographics_df$age.at.time.of.study)
```

